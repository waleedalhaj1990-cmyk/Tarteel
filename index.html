<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªØ³Ù…ÙŠØ¹ ÙˆØªÙ„Ø§ÙˆØ© Ø§Ù„Ù‚Ø±Ø¢Ù† - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…ÙØµØ­ÙÙ‘Ø­Ø©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <style>
        :root {
            --bg: #050b10;
            --card-bg: #111827;
            --accent: #22c55e;
            --accent-light: #4ade80;
            --accent-blue: #3b82f6;
            --accent-yellow: #eab308;
            --text-main: #f9fafb;
            --text-sub: #9ca3af;
            --border: #1f2933;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #0f172a 0, #020617 60%);
            color: var(--text-main);
        }

        .app {
            max-width: 480px;
            margin: 0 auto;
            padding: 1rem 0.8rem 1.5rem;
        }

        .card {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 18px;
            padding: 1rem 0.8rem 1.2rem;
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            backdrop-filter: blur(12px);
        }

        h1 {
            font-size: 1.3rem;
            margin: 0 0 0.25rem;
            text-align: center;
        }

        .subtitle {
            font-size: 0.8rem;
            text-align: center;
            color: var(--text-sub);
            margin-bottom: 0.8rem;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .field {
            flex: 1 1 100%;
        }

        .field-half {
            flex: 1 1 calc(50% - 0.25rem);
        }

        label {
            display: block;
            font-size: 0.78rem;
            margin-bottom: 0.15rem;
            color: var(--text-sub);
        }

        select,
        input[type="number"],
        input[type="range"] {
            width: 100%;
            padding: 0.45rem 0.5rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #020617;
            color: var(--text-main);
            font-size: 0.9rem;
        }

        select:disabled,
        input:disabled {
            opacity: 0.6;
        }

        .range-value {
            font-size: 0.8rem;
            color: var(--text-sub);
            text-align: left;
            margin-top: 0.15rem;
        }

        .buttons {
            display: flex;
            gap: 0.4rem;
            margin: 0.7rem 0 0.3rem;
        }

        .btn {
            flex: 1 1 0;
            border: none;
            border-radius: 999px;
            padding: 0.55rem 0.4rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .btn span.emoji {
            font-size: 1.05rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #16a34a, #22c55e);
            color: #ecfdf5;
            box-shadow: 0 8px 18px rgba(34, 197, 94, 0.40);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #0ea5e9, #3b82f6);
            color: #eff6ff;
            box-shadow: 0 8px 18px rgba(59, 130, 246, 0.40);
        }

        .btn-stop {
            background: linear-gradient(135deg, #dc2626, #f97316);
            color: #fef2f2;
            box-shadow: 0 8px 18px rgba(239, 68, 68, 0.40);
        }

        .btn:disabled {
            opacity: 0.35;
            cursor: default;
            transform: none;
            box-shadow: none;
        }

        .btn:not(:disabled):active {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
        }

        .status-row {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.4rem;
        }

        .status {
            flex: 1;
            font-size: 0.82rem;
            min-height: 1.1rem;
            color: var(--text-sub);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-strong {
            color: var(--accent);
        }
        .status-warn {
            color: var(--accent-yellow);
        }
        .status-info {
            color: var(--accent-blue);
        }
        .status-done {
            color: #facc15;
            font-weight: 600;
        }
        .status-error {
            color: var(--danger);
        }

        .listening-indicator {
            width: 14px;
            height: 14px;
            border-radius: 999px;
            border: 2px solid rgba(74, 222, 128, 0.5);
            box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4);
            transform: scale(1);
            opacity: 0;
        }

        .listening-indicator.active {
            background: var(--accent-light);
            opacity: 1;
            animation: pulse 1.4s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4);
            }
            70% {
                transform: scale(1.4);
                box-shadow: 0 0 0 12px rgba(74, 222, 128, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
            }
        }

        .recognized-text-box {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            min-height: 2.5rem;
            font-size: 0.85rem;
            color: #bfdbfe;
            line-height: 1.5;
            display: none;
        }

        .recognized-text-box.active {
            display: block;
        }

        .recognized-label {
            font-size: 0.7rem;
            color: var(--text-sub);
            margin-bottom: 0.2rem;
        }

        .progress-wrapper {
            margin-top: 0.8rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.18);
        }

        .progress-bar-inner {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #84cc16);
            transition: width 0.2s ease;
        }

        .progress-text {
            margin-top: 0.25rem;
            font-size: 0.8rem;
            color: var(--text-sub);
            display: flex;
            justify-content: space-between;
        }

        .ayah-box {
            margin-top: 0.8rem;
            border-radius: 14px;
            padding: 0.6rem 0.6rem 0.5rem;
            background: radial-gradient(circle at top right, rgba(22, 163, 74, 0.15), rgba(15, 23, 42, 0.95));
            border: 1px solid rgba(148, 163, 184, 0.18);
            min-height: 3.1rem;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .ayah-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.78rem;
            color: var(--text-sub);
        }

        .ayah-text {
            font-size: 1.02rem;
            line-height: 1.7;
            word-spacing: 0.15em;
            text-align: justify;
        }

        .ayah-word {
            display: inline-block;
            padding: 0 0.12rem;
            border-radius: 6px;
            transition: background 0.12s ease, color 0.12s ease, transform 0.12s ease;
        }

        .ayah-word.active-tilawa {
            background: rgba(34, 197, 94, 0.25);
            color: #bbf7d0;
            transform: translateY(-1px);
        }

        .ayah-word.active-tasmi {
            background: rgba(59, 130, 246, 0.30);
            color: #dbeafe;
            transform: translateY(-1px);
        }

        .mode-badge {
            font-size: 0.72rem;
            padding: 0.12rem 0.4rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: var(--text-sub);
        }

        .mode-badge-tilawa {
            border-color: rgba(34, 197, 94, 0.6);
            color: #bbf7d0;
        }
        .mode-badge-tasmi {
            border-color: rgba(59, 130, 246, 0.6);
            color: #bfdbfe;
        }

        .footer-note {
            margin-top: 0.7rem;
            font-size: 0.72rem;
            color: var(--text-sub);
            text-align: center;
        }

        @media (min-width: 520px) {
            .app {
                padding-top: 1.5rem;
            }
            .card {
                padding: 1.2rem 1.1rem 1.3rem;
            }
        }
    </style>
</head>
<body>
<div class="app">
    <div class="card">
        <h1>Ù…Ø³Ø§Ø¹Ø¯ ØªØ³Ù…ÙŠØ¹ ÙˆØªÙ„Ø§ÙˆØ© Ø§Ù„Ù‚Ø±Ø¢Ù†</h1>
        <div class="subtitle">ÙŠØ³Ù…Ø¹ Ù‚Ø±Ø§Ø¡ØªÙƒ ğŸ¤ ÙˆÙŠØ´ØºÙ‘Ù„ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªÙŠ Ù„Ù… ØªÙ‚Ø±Ø£Ù‡Ø§ ğŸ“–</div>

        <div class="row">
            <div class="field">
                <label for="surahSelect">Ø§Ù„Ø³ÙˆØ±Ø© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
                <select id="surahSelect">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø©...</option>
                </select>
            </div>

            <div class="field-half">
                <label for="ayahInput">Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© (Ù„Ù„ØªÙ„Ø§ÙˆØ© ÙÙ‚Ø·)</label>
                <input id="ayahInput" type="number" min="1" placeholder="Ù…Ø«Ù„Ø§Ù‹: 1">
            </div>

            <div class="field-half">
                <label for="reciterSelect">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø±Ø¦</label>
                <select id="reciterSelect">
                    <option value="ar.alafasy">Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ</option>
                    <option value="ar.abdulbasitmurattal">Ø¹Ø¨Ø¯ Ø§Ù„Ø¨Ø§Ø³Ø· (Ù…Ø±ØªÙ„)</option>
                    <option value="ar.abdurrahmaansudais">Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø³Ø¯ÙŠØ³</option>
                    <option value="ar.shaatree">Ø£Ø¨Ùˆ Ø¨ÙƒØ± Ø§Ù„Ø´Ø§Ø·Ø±ÙŠ</option>
                    <option value="ar.hanirifai">Ù‡Ø§Ù†ÙŠ Ø§Ù„Ø±ÙØ§Ø¹ÙŠ</option>
                    <option value="ar.husary">Ù…Ø­Ù…ÙˆØ¯ Ø§Ù„Ø­ØµØ±ÙŠ</option>
                    <option value="ar.minshawi">Ù…Ø­Ù…Ø¯ Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ</option>
                    <option value="ar.muhammadayyoub">Ù…Ø­Ù…Ø¯ Ø£ÙŠÙˆØ¨</option>
                    <option value="ar.saoodshuraym">Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø´Ø±ÙŠÙ…</option>
                    <option value="ar.hudhaify">Ø¹Ù„ÙŠ Ø§Ù„Ø­Ø°ÙŠÙÙŠ</option>
                </select>
            </div>

            <div class="field">
                <label for="delayRange">Ù…Ù†Ø²Ù„Ù‚ Ø§Ù„ØªØ£Ø®ÙŠØ± (Ø¥Ø°Ø§ Ù„Ù… ÙŠÙ‚Ø±Ø£ Ø§Ù„Ù‚Ø§Ø±Ø¦)</label>
                <input id="delayRange" type="range" min="5" max="20" step="1" value="10">
                <div id="delayValue" class="range-value">Ù…Ø¯Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: 10 Ø«Ø§Ù†ÙŠØ©</div>
            </div>
        </div>

        <div class="buttons">
            <button id="btnTasmi" class="btn btn-primary">
                <span class="emoji">ğŸ¤</span><span>ØªØ³Ù…ÙŠØ¹</span>
            </button>
            <button id="btnTilawa" class="btn btn-secondary">
                <span class="emoji">ğŸ“–</span><span>ØªÙ„Ø§ÙˆØ©</span>
            </button>
            <button id="btnStop" class="btn btn-stop">
                <span class="emoji">â¹ï¸</span><span>Ø¥ÙŠÙ‚Ø§Ù</span>
            </button>
        </div>

        <div class="status-row">
            <div id="listeningDot" class="listening-indicator"></div>
            <div id="statusMessage" class="status">Ø¬Ø§Ù‡Ø² Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙˆØ±Ø©</div>
        </div>

        <div id="recognizedBox" class="recognized-text-box">
            <div class="recognized-label">ğŸ™ï¸ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙØªØ¹Ø±ÙÙ‘Ù Ø¹Ù„ÙŠÙ‡:</div>
            <div id="recognizedText" style="color: #dbeafe;">Ø¬Ø§Ø±Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...</div>
        </div>

        <div class="progress-wrapper">
            <div class="progress-bar">
                <div id="progressInner" class="progress-bar-inner"></div>
            </div>
            <div class="progress-text">
                <span id="progressAyah">Ø§Ù„Ø¢ÙŠØ©: - / -</span>
                <span id="progressPercent">0%</span>
            </div>
        </div>

        <div class="ayah-box">
            <div class="ayah-header">
                <span id="ayahLabel">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢ÙŠØ© Ù…Ø¹Ø±ÙˆØ¶Ø©</span>
                <span id="modeBadge" class="mode-badge">ÙˆØ¶Ø¹ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„</span>
            </div>
            <div id="ayahText" class="ayah-text"></div>
        </div>

        <div class="footer-note">
            ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Web Speech API (ÙƒØ±ÙˆÙ…) â€¢ ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
        </div>
    </div>
</div>

<script>
const SURAHS = [
    {number:1,name:"Ø§Ù„ÙØ§ØªØ­Ø©",englishName:"Al-Faatiha",ayahs:7},
    {number:2,name:"Ø§Ù„Ø¨Ù‚Ø±Ø©",englishName:"Al-Baqara",ayahs:286},
    {number:3,name:"Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†",englishName:"Aal-i-Imraan",ayahs:200},
    {number:4,name:"Ø§Ù„Ù†Ø³Ø§Ø¡",englishName:"An-Nisaa",ayahs:176},
    {number:5,name:"Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©",englishName:"Al-Maaida",ayahs:120},
    {number:6,name:"Ø§Ù„Ø£Ù†Ø¹Ø§Ù…",englishName:"Al-An'aam",ayahs:165},
    {number:7,name:"Ø§Ù„Ø£Ø¹Ø±Ø§Ù",englishName:"Al-A'raaf",ayahs:206},
    {number:8,name:"Ø§Ù„Ø£Ù†ÙØ§Ù„",englishName:"Al-Anfaal",ayahs:75},
    {number:9,name:"Ø§Ù„ØªÙˆØ¨Ø©",englishName:"At-Tawba",ayahs:129},
    {number:10,name:"ÙŠÙˆÙ†Ø³",englishName:"Yunus",ayahs:109},
    {number:11,name:"Ù‡ÙˆØ¯",englishName:"Hud",ayahs:123},
    {number:12,name:"ÙŠÙˆØ³Ù",englishName:"Yusuf",ayahs:111},
    {number:13,name:"Ø§Ù„Ø±Ø¹Ø¯",englishName:"Ar-Ra'd",ayahs:43},
    {number:14,name:"Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…",englishName:"Ibrahim",ayahs:52},
    {number:15,name:"Ø§Ù„Ø­Ø¬Ø±",englishName:"Al-Hijr",ayahs:99},
    {number:16,name:"Ø§Ù„Ù†Ø­Ù„",englishName:"An-Nahl",ayahs:128},
    {number:17,name:"Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡",englishName:"Al-Israa",ayahs:111},
    {number:18,name:"Ø§Ù„ÙƒÙ‡Ù",englishName:"Al-Kahf",ayahs:110},
    {number:19,name:"Ù…Ø±ÙŠÙ…",englishName:"Maryam",ayahs:98},
    {number:20,name:"Ø·Ù‡",englishName:"Taa-Haa",ayahs:135},
    {number:21,name:"Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡",englishName:"Al-Anbiyaa",ayahs:112},
    {number:22,name:"Ø§Ù„Ø­Ø¬",englishName:"Al-Hajj",ayahs:78},
    {number:23,name:"Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†",englishName:"Al-Muminoon",ayahs:118},
    {number:24,name:"Ø§Ù„Ù†ÙˆØ±",englishName:"An-Noor",ayahs:64},
    {number:25,name:"Ø§Ù„ÙØ±Ù‚Ø§Ù†",englishName:"Al-Furqaan",ayahs:77},
    {number:26,name:"Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡",englishName:"Ash-Shu'araa",ayahs:227},
    {number:27,name:"Ø§Ù„Ù†Ù…Ù„",englishName:"An-Naml",ayahs:93},
    {number:28,name:"Ø§Ù„Ù‚ØµØµ",englishName:"Al-Qasas",ayahs:88},
    {number:29,name:"Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª",englishName:"Al-Ankaboot",ayahs:69},
    {number:30,name:"Ø§Ù„Ø±ÙˆÙ…",englishName:"Ar-Room",ayahs:60},
    {number:31,name:"Ù„Ù‚Ù…Ø§Ù†",englishName:"Luqman",ayahs:34},
    {number:32,name:"Ø§Ù„Ø³Ø¬Ø¯Ø©",englishName:"As-Sajda",ayahs:30},
    {number:33,name:"Ø§Ù„Ø£Ø­Ø²Ø§Ø¨",englishName:"Al-Ahzaab",ayahs:73},
    {number:34,name:"Ø³Ø¨Ø£",englishName:"Saba",ayahs:54},
    {number:35,name:"ÙØ§Ø·Ø±",englishName:"Faatir",ayahs:45},
    {number:36,name:"ÙŠØ³",englishName:"Yaseen",ayahs:83},
    {number:37,name:"Ø§Ù„ØµØ§ÙØ§Øª",englishName:"As-Saaffaat",ayahs:182},
    {number:38,name:"Øµ",englishName:"Saad",ayahs:88},
    {number:39,name:"Ø§Ù„Ø²Ù…Ø±",englishName:"Az-Zumar",ayahs:75},
    {number:40,name:"ØºØ§ÙØ±",englishName:"Ghafir",ayahs:85},
    {number:41,name:"ÙØµÙ„Øª",englishName:"Fussilat",ayahs:54},
    {number:42,name:"Ø§Ù„Ø´ÙˆØ±Ù‰",englishName:"Ash-Shura",ayahs:53},
    {number:43,name:"Ø§Ù„Ø²Ø®Ø±Ù",englishName:"Az-Zukhruf",ayahs:89},
    {number:44,name:"Ø§Ù„Ø¯Ø®Ø§Ù†",englishName:"Ad-Dukhaan",ayahs:59},
    {number:45,name:"Ø§Ù„Ø¬Ø§Ø«ÙŠØ©",englishName:"Al-Jaathiya",ayahs:37},
    {number:46,name:"Ø§Ù„Ø£Ø­Ù‚Ø§Ù",englishName:"Al-Ahqaf",ayahs:35},
    {number:47,name:"Ù…Ø­Ù…Ø¯",englishName:"Muhammad",ayahs:38},
    {number:48,name:"Ø§Ù„ÙØªØ­",englishName:"Al-Fath",ayahs:29},
    {number:49,name:"Ø§Ù„Ø­Ø¬Ø±Ø§Øª",englishName:"Al-Hujuraat",ayahs:18},
    {number:50,name:"Ù‚",englishName:"Qaaf",ayahs:45},
    {number:51,name:"Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª",englishName:"Adh-Dhaariyat",ayahs:60},
    {number:52,name:"Ø§Ù„Ø·ÙˆØ±",englishName:"At-Tur",ayahs:49},
    {number:53,name:"Ø§Ù„Ù†Ø¬Ù…",englishName:"An-Najm",ayahs:62},
    {number:54,name:"Ø§Ù„Ù‚Ù…Ø±",englishName:"Al-Qamar",ayahs:55},
    {number:55,name:"Ø§Ù„Ø±Ø­Ù…Ù†",englishName:"Ar-Rahmaan",ayahs:78},
    {number:56,name:"Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©",englishName:"Al-Waaqia",ayahs:96},
    {number:57,name:"Ø§Ù„Ø­Ø¯ÙŠØ¯",englishName:"Al-Hadid",ayahs:29},
    {number:58,name:"Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©",englishName:"Al-Mujaadila",ayahs:22},
    {number:59,name:"Ø§Ù„Ø­Ø´Ø±",englishName:"Al-Hashr",ayahs:24},
    {number:60,name:"Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©",englishName:"Al-Mumtahana",ayahs:13},
    {number:61,name:"Ø§Ù„ØµÙ",englishName:"As-Saff",ayahs:14},
    {number:62,name:"Ø§Ù„Ø¬Ù…Ø¹Ø©",englishName:"Al-Jumu'a",ayahs:11},
    {number:63,name:"Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†",englishName:"Al-Munaafiqoon",ayahs:11},
    {number:64,name:"Ø§Ù„ØªØºØ§Ø¨Ù†",englishName:"At-Taghaabun",ayahs:18},
    {number:65,name:"Ø§Ù„Ø·Ù„Ø§Ù‚",englishName:"At-Talaaq",ayahs:12},
    {number:66,name:"Ø§Ù„ØªØ­Ø±ÙŠÙ…",englishName:"At-Tahrim",ayahs:12},
    {number:67,name:"Ø§Ù„Ù…Ù„Ùƒ",englishName:"Al-Mulk",ayahs:30},
    {number:68,name:"Ø§Ù„Ù‚Ù„Ù…",englishName:"Al-Qalam",ayahs:52},
    {number:69,name:"Ø§Ù„Ø­Ø§Ù‚Ø©",englishName:"Al-Haaqqa",ayahs:52},
    {number:70,name:"Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬",englishName:"Al-Ma'aarij",ayahs:44},
    {number:71,name:"Ù†ÙˆØ­",englishName:"Nooh",ayahs:28},
    {number:72,name:"Ø§Ù„Ø¬Ù†",englishName:"Al-Jinn",ayahs:28},
    {number:73,name:"Ø§Ù„Ù…Ø²Ù…Ù„",englishName:"Al-Muzzammil",ayahs:20},
    {number:74,name:"Ø§Ù„Ù…Ø¯Ø«Ø±",englishName:"Al-Muddaththir",ayahs:56},
    {number:75,name:"Ø§Ù„Ù‚ÙŠØ§Ù…Ø©",englishName:"Al-Qiyaama",ayahs:40},
    {number:76,name:"Ø§Ù„Ø¥Ù†Ø³Ø§Ù†",englishName:"Al-Insaan",ayahs:31},
    {number:77,name:"Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª",englishName:"Al-Mursalaat",ayahs:50},
    {number:78,name:"Ø§Ù„Ù†Ø¨Ø£",englishName:"An-Naba",ayahs:40},
    {number:79,name:"Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª",englishName:"An-Naazi'aat",ayahs:46},
    {number:80,name:"Ø¹Ø¨Ø³",englishName:"Abasa",ayahs:42},
    {number:81,name:"Ø§Ù„ØªÙƒÙˆÙŠØ±",englishName:"At-Takwir",ayahs:29},
    {number:82,name:"Ø§Ù„Ø¥Ù†ÙØ·Ø§Ø±",englishName:"Al-Infitaar",ayahs:19},
    {number:83,name:"Ø§Ù„Ù…Ø·ÙÙÙŠÙ†",englishName:"Al-Mutaffifin",ayahs:36},
    {number:84,name:"Ø§Ù„Ø¥Ù†Ø´Ù‚Ø§Ù‚",englishName:"Al-Inshiqaaq",ayahs:25},
    {number:85,name:"Ø§Ù„Ø¨Ø±ÙˆØ¬",englishName:"Al-Burooj",ayahs:22},
    {number:86,name:"Ø§Ù„Ø·Ø§Ø±Ù‚",englishName:"At-Taariq",ayahs:17},
    {number:87,name:"Ø§Ù„Ø£Ø¹Ù„Ù‰",englishName:"Al-A'laa",ayahs:19},
    {number:88,name:"Ø§Ù„ØºØ§Ø´ÙŠØ©",englishName:"Al-Ghaashiya",ayahs:26},
    {number:89,name:"Ø§Ù„ÙØ¬Ø±",englishName:"Al-Fajr",ayahs:30},
    {number:90,name:"Ø§Ù„Ø¨Ù„Ø¯",englishName:"Al-Balad",ayahs:20},
    {number:91,name:"Ø§Ù„Ø´Ù…Ø³",englishName:"Ash-Shams",ayahs:15},
    {number:92,name:"Ø§Ù„Ù„ÙŠÙ„",englishName:"Al-Lail",ayahs:21},
    {number:93,name:"Ø§Ù„Ø¶Ø­Ù‰",englishName:"Ad-Dhuhaa",ayahs:11},
    {number:94,name:"Ø§Ù„Ø´Ø±Ø­",englishName:"Ash-Sharh",ayahs:8},
    {number:95,name:"Ø§Ù„ØªÙŠÙ†",englishName:"At-Tin",ayahs:8},
    {number:96,name:"Ø§Ù„Ø¹Ù„Ù‚",englishName:"Al-Alaq",ayahs:19},
    {number:97,name:"Ø§Ù„Ù‚Ø¯Ø±",englishName:"Al-Qadr",ayahs:5},
    {number:98,name:"Ø§Ù„Ø¨ÙŠÙ†Ø©",englishName:"Al-Bayyina",ayahs:8},
    {number:99,name:"Ø§Ù„Ø²Ù„Ø²Ù„Ø©",englishName:"Az-Zalzala",ayahs:8},
    {number:100,name:"Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª",englishName:"Al-Aadiyaat",ayahs:11},
    {number:101,name:"Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©",englishName:"Al-Qaari'a",ayahs:11},
    {number:102,name:"Ø§Ù„ØªÙƒØ§Ø«Ø±",englishName:"At-Takaathur",ayahs:8},
    {number:103,name:"Ø§Ù„Ø¹ØµØ±",englishName:"Al-Asr",ayahs:3},
    {number:104,name:"Ø§Ù„Ù‡Ù…Ø²Ø©",englishName:"Al-Humaza",ayahs:9},
    {number:105,name:"Ø§Ù„ÙÙŠÙ„",englishName:"Al-Fil",ayahs:5},
    {number:106,name:"Ù‚Ø±ÙŠØ´",englishName:"Quraish",ayahs:4},
    {number:107,name:"Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†",englishName:"Al-Maa'un",ayahs:7},
    {number:108,name:"Ø§Ù„ÙƒÙˆØ«Ø±",englishName:"Al-Kawthar",ayahs:3},
    {number:109,name:"Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†",englishName:"Al-Kaafiroon",ayahs:6},
    {number:110,name:"Ø§Ù„Ù†ØµØ±",englishName:"An-Nasr",ayahs:3},
    {number:111,name:"Ø§Ù„Ù…Ø³Ø¯",englishName:"Al-Masad",ayahs:5},
    {number:112,name:"Ø§Ù„Ø¥Ø®Ù„Ø§Øµ",englishName:"Al-Ikhlaas",ayahs:4},
    {number:113,name:"Ø§Ù„ÙÙ„Ù‚",englishName:"Al-Falaq",ayahs:5},
    {number:114,name:"Ø§Ù„Ù†Ø§Ø³",englishName:"An-Naas",ayahs:6}
];

const API_BASE = "https://api.alquran.cloud/v1";
const DEFAULT_TEXT_EDITION = "quran-uthmani";
let currentAudioEdition = "ar.alafasy";

const surahSelect = document.getElementById("surahSelect");
const ayahInput = document.getElementById("ayahInput");
const reciterSelect = document.getElementById("reciterSelect");
const delayRange = document.getElementById("delayRange");
const delayValue = document.getElementById("delayValue");
const btnTasmi = document.getElementById("btnTasmi");
const btnTilawa = document.getElementById("btnTilawa");
const btnStop = document.getElementById("btnStop");

const statusMessage = document.getElementById("statusMessage");
const listeningDot = document.getElementById("listeningDot");
const progressInner = document.getElementById("progressInner");
const progressAyah = document.getElementById("progressAyah");
const progressPercent = document.getElementById("progressPercent");
const ayahLabel = document.getElementById("ayahLabel");
const ayahTextBox = document.getElementById("ayahText");
const modeBadge = document.getElementById("modeBadge");
const recognizedBox = document.getElementById("recognizedBox");
const recognizedText = document.getElementById("recognizedText");

let mode = "idle";
let currentSurah = null;
let ayahs = [];
let currentAyahIndex = -1;
let expectedAyahIndex = 0;
let recognition = null;
let recognizing = false;
let countdownTimer = null;
let countdownSeconds = 0;
let currentAudio = null;
let wordTimer = null;

function normalizeArabic(text) {
    if (!text) return "";
    let t = text;
    t = t.replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g, "");
    t = t.replace(/[Ø¥Ø£Ø¢Ù±Ø§]/g, "Ø§");
    t = t.replace(/[Ø¤]/g, "Ùˆ");
    t = t.replace(/[Ø¦]/g, "ÙŠ");
    t = t.replace(/[Ù‰Ø©Ù‡]/g, "Ù‡");
    t = t.replace(/[Ù€]/g, "");
    t = t.replace(/[\d\u0660-\u0669]/g, "");
    t = t.replace(/[^\u0600-\u06FF\s]/g, " ");
    t = t.replace(/\s+/g, " ").trim();
    return t;
}

function splitWords(text) {
    const clean = text.replace(/\s+/g, " ").trim();
    return clean ? clean.split(" ") : [];
}

function calculateBasicSimilarity(words1, words2) {
    if (!words1.length || !words2.length) return 0;
    
    let matches = 0;
    const set2 = new Set(words2);
    words1.forEach(w => {
        if (w.length >= 2 && set2.has(w)) matches++;
    });
    
    return matches / Math.max(words1.length, words2.length);
}

function calculateSimilarity(text1, text2) {
    const words1 = splitWords(normalizeArabic(text1));
    const words2 = splitWords(normalizeArabic(text2));
    
    if (!words1.length || !words2.length) return 0;
    
    const stopWords = new Set(["Ùˆ", "ÙÙŠ", "Ù…Ù†", "Ø§Ù„ÙŠ", "Ø¹Ù„ÙŠ", "Ø§Ù†", "Ø«Ù…", "Ø§Ùˆ", "Ù", "Ù„"]);
    const filtered1 = words1.filter(w => w.length >= 2 && !stopWords.has(w));
    const filtered2 = words2.filter(w => w.length >= 2 && !stopWords.has(w));
    
    if (!filtered1.length || !filtered2.length) {
        return calculateBasicSimilarity(words1, words2);
    }
    
    let exactMatches = 0;
    const set2 = new Set(filtered2);
    filtered1.forEach(w => {
        if (set2.has(w)) exactMatches++;
    });
    
    let partialMatches = 0;
    filtered1.forEach(w1 => {
        filtered2.forEach(w2 => {
            if (w1.length >= 3 && w2.length >= 3) {
                if (w1.includes(w2) || w2.includes(w1)) {
                    partialMatches += 0.7;
                }
            }
        });
    });
    
    let lcsLength = 0;
    for (let i = 0; i < filtered1.length; i++) {
        for (let j = 0; j < filtered2.length; j++) {
            if (filtered1[i] === filtered2[j]) {
                let k = 1;
                while (i + k < filtered1.length && j + k < filtered2.length && 
                       filtered1[i + k] === filtered2[j + k]) {
                    k++;
                }
                lcsLength = Math.max(lcsLength, k);
            }
        }
    }
    
    const score1 = exactMatches / filtered1.length;
    const score2 = exactMatches / filtered2.length;
    const score3 = (exactMatches + partialMatches) / Math.max(filtered1.length, filtered2.length);
    const score4 = lcsLength / Math.max(filtered1.length, filtered2.length);
    
    return Math.max(score1, score2, score3, score4);
}

function isBasmala(text) {
    const norm = normalizeArabic(text);
    const basmalaWords = ["Ø¨Ø³Ù…", "Ø§Ù„Ù„Ù‡", "Ø§Ù„Ø±Ø­Ù…Ù†", "Ø§Ù„Ø±Ø­ÙŠÙ…"];
    let count = 0;
    basmalaWords.forEach(w => {
        if (norm.includes(w)) count++;
    });
    return count >= 3;
}

function loadSurahList() {
    surahSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø©...</option>';
    SURAHS.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.number;
        opt.textContent = `${s.number}. ${s.englishName} - ${s.name}`;
        opt.dataset.ayahs = s.ayahs;
        surahSelect.appendChild(opt);
    });
    setStatus("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¶Ø¹: ØªØ³Ù…ÙŠØ¹ Ø£Ùˆ ØªÙ„Ø§ÙˆØ©", "normal");
}

async function loadSurah(surahNumber) {
    if (!surahNumber) return;
    try {
        setStatus("Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù†ØµÙˆØµ ÙˆØ¢ÙŠØ§Øª Ø§Ù„Ø³ÙˆØ±Ø©...", "info");
        ayahs = [];
        currentSurah = null;

        const textUrl = `${API_BASE}/surah/${surahNumber}/${DEFAULT_TEXT_EDITION}`;
        const audioUrl = `${API_BASE}/surah/${surahNumber}/${currentAudioEdition}`;

        const [textResp, audioResp] = await Promise.all([
            fetch(textUrl),
            fetch(audioUrl)
        ]);

        const [textJson, audioJson] = await Promise.all([
            textResp.json(),
            audioResp.json()
        ]);

        if (textJson.code !== 200 || audioJson.code !== 200) {
            throw new Error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…");
        }

        const textAyahs = textJson.data.ayahs;
        const audioAyahs = audioJson.data.ayahs;

        ayahs = textAyahs.map((a, idx) => {
            const audioAyah = audioAyahs[idx] || {};
            return {
                numberInSurah: a.numberInSurah,
                text: a.text,
                normalizedText: normalizeArabic(a.text),
                audioUrl: audioAyah.audio || ""
            };
        });

        currentSurah = surahNumber;
        currentAyahIndex = -1;
        expectedAyahIndex = 0;

        updateProgress(0, ayahs.length);
        ayahLabel.textContent = "Ø§Ù„Ø³ÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø©";
        ayahTextBox.textContent = "Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ù…ÙŠØ¹ Ø£Ùˆ Ø§Ù„ØªÙ„Ø§ÙˆØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¢ÙŠØ§Øª.";

        setStatus("Ø§Ù„Ø³ÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø© âœ”ï¸", "strong");
    } catch (e) {
        console.error(e);
        setStatus("ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.", "error");
    }
}

function updateProgress(currentIndex, total) {
    const curr = currentIndex > 0 ? currentIndex : 0;
    const percent = total > 0 ? Math.round((curr / total) * 100) : 0;
    progressInner.style.width = percent + "%";
    progressAyah.textContent = `Ø§Ù„Ø¢ÙŠØ©: ${curr} / ${total || "-"}`;
    progressPercent.textContent = percent + "%";
}

function clearWordHighlight() {
    if (wordTimer) {
        clearInterval(wordTimer);
        wordTimer = null;
    }
}

function renderAyahWords(ayahText) {
    clearWordHighlight();
    ayahTextBox.innerHTML = "";
    if (!ayahText) return;

    const words = splitWords(ayahText);
    words.forEach((w, idx) => {
        const span = document.createElement("span");
        span.textContent = w + " ";
        span.className = "ayah-word";
        span.dataset.index = idx;
        ayahTextBox.appendChild(span);
    });
}

function animateWordsWithAudio(audio, modeKind) {
    clearWordHighlight();

    const spans = Array.from(document.querySelectorAll(".ayah-word"));
    if (!spans.length || !audio) return;

    const activeClass = modeKind === "tilawa" ? "active-tilawa" : "active-tasmi";

    function clearActive() {
        spans.forEach(s => s.classList.remove("active-tilawa", "active-tasmi"));
    }

    let idx = 0;
    const startAnimation = () => {
        clearActive();
        const duration = audio.duration || 10;
        const step = duration / (spans.length || 1);

        wordTimer = setInterval(() => {
            clearActive();
            if (idx >= spans.length) {
                clearInterval(wordTimer);
                wordTimer = null;
                return;
            }
            spans[idx].classList.add(activeClass);
            idx++;
        }, step * 1000);
    };

    if (audio.readyState >= 1) {
        startAnimation();
    } else {
        audio.addEventListener("loadedmetadata", () => {
            startAnimation();
        }, { once: true });
    }

    audio.addEventListener("ended", () => {
        clearActive();
        clearWordHighlight();
    }, { once: false });
}

function stopCurrentAudio() {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }
    clearWordHighlight();
}

function playAyahAudio(index, playMode) {
    if (!ayahs.length || index < 0 || index >= ayahs.length) return;

    const ayah = ayahs[index];
    if (!ayah.audioUrl) {
        setStatus("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ØµÙˆØª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¢ÙŠØ© ÙÙŠ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ.", "error");
        return;
    }

    stopCurrentAudio();

    const audio = new Audio(ayah.audioUrl);
    currentAudio = audio;

    ayahLabel.textContent = `Ø§Ù„Ø¢ÙŠØ© ${ayah.numberInSurah}`;
    renderAyahWords(ayah.text);
    animateWordsWithAudio(audio, playMode);

    if (playMode === "tilawa") {
        setStatus(`ğŸ“– ØªÙ„Ø§ÙˆØ© Ø¢ÙŠØ© ${ayah.numberInSurah}`, "strong");
        modeBadge.textContent = "ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ø§ÙˆØ©";
        modeBadge.className = "mode-badge mode-badge-tilawa";
        updateProgress(ayah.numberInSurah, ayahs.length);
    } else {
        setStatus(`ğŸ“» ØªØ´ØºÙŠÙ„ Ø¢ÙŠØ© ${ayah.numberInSurah} (Ù„Ù… ÙŠÙ‚Ø±Ø£Ù‡Ø§ Ø§Ù„Ù‚Ø§Ø±Ø¦)`, "info");
        modeBadge.textContent = "ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ù…ÙŠØ¹ (ØªØ´ØºÙŠÙ„)";
        modeBadge.className = "mode-badge mode-badge-tasmi";
        updateProgress(ayah.numberInSurah, ayahs.length);
    }

    audio.play().catch(e => {
        console.error(e);
        setStatus("ØªØ¹Ø°Ù‘Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØµÙˆØª.", "error");
    });

    audio.addEventListener("ended", () => {
        if (playMode === "tilawa") {
            setTimeout(() => {
                if (mode === "tilawa") {
                    currentAyahIndex++;
                    if (currentAyahIndex >= ayahs.length) {
                        setStatus("ğŸ‰ Ø¥ÙƒÙ…Ø§Ù„! Ø§Ù†ØªÙ‡ÙŠØª Ù…Ù† Ø§Ù„Ø³ÙˆØ±Ø©.", "done");
                        modeBadge.textContent = "Ù…ÙƒØªÙ…Ù„";
                        updateProgress(ayahs.length, ayahs.length);
                        mode = "idle";
                        enableMainControls(true);
                    } else {
                        playAyahAudio(currentAyahIndex, "tilawa");
                    }
                }
            }, 1200);
        } else if (playMode === "tasmi") {
            if (mode === "tasmi") {
                expectedAyahIndex++;
                console.log(`âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ´ØºÙŠÙ„ - Ø§Ù„Ø¢Ù† Ù†Ù†ØªØ¸Ø± Ø§Ù„Ø¢ÙŠØ© ${expectedAyahIndex + 1}`);
                
                if (expectedAyahIndex < ayahs.length) {
                    updateProgress(expectedAyahIndex + 1, ayahs.length);
                    ayahLabel.textContent = `Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¢ÙŠØ© ${expectedAyahIndex + 1}`;
                    ayahTextBox.textContent = ayahs[expectedAyahIndex].text;
                    
                    setTimeout(() => {
                        startRecognition();
                    }, 500);
                } else {
                    setStatus("ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ø³ÙˆØ±Ø©.", "done");
                    modeBadge.textContent = "Ù…ÙƒØªÙ…Ù„";
                    updateProgress(ayahs.length, ayahs.length);
                    mode = "idle";
                    enableMainControls(true);
                    recognizedBox.classList.remove("active");
                    stopRecognition();
                }
            }
        }
    });
}

function startTilawa() {
    if (!currentSurah || !ayahs.length) {
        setStatus("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹ØŒ ÙŠØªÙ… Ø¨Ø¹Ø¯Ù‡Ø§ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢ÙŠØ§Øª.", "error");
        return;
    }
    stopCurrentAudio();
    cancelCountdown();
    stopRecognition();

    mode = "tilawa";
    enableMainControls(false);
    ayahInput.disabled = false;
    listeningDot.classList.remove("active");
    recognizedBox.classList.remove("active");

    const total = ayahs.length;
    let startIndex = 0;

    const desiredAyah = parseInt(ayahInput.value, 10);
    if (!isNaN(desiredAyah) && desiredAyah >= 1 && desiredAyah <= total) {
        startIndex = desiredAyah - 1;
    }

    currentAyahIndex = startIndex;

    if (currentSurah !== "9" && currentAyahIndex === 0) {
        updateProgress(0, total);
        playBasmalaThenFirstAyah();
    } else {
        updateProgress(currentAyahIndex + 1, total);
        playAyahAudio(currentAyahIndex, "tilawa");
    }
}

function playBasmalaThenFirstAyah() {
    stopCurrentAudio();

    const basmalaUrl = `https://cdn.islamic.network/quran/audio/128/${currentAudioEdition}/1.mp3`;

    const audio = new Audio(basmalaUrl);
    currentAudio = audio;

    const basmalaText = "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù";
    ayahLabel.textContent = "Ø§Ù„Ø¨Ø³Ù…Ù„Ø©";
    renderAyahWords(basmalaText);
    animateWordsWithAudio(audio, "tilawa");

    setStatus("ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø³Ù…Ù„Ø©...", "strong");
    modeBadge.textContent = "ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ø§ÙˆØ©";
    modeBadge.className = "mode-badge mode-badge-tilawa";
    
    updateProgress(0, ayahs.length);

    audio.play().catch(e => {
        console.error(e);
        setStatus("ØªØ¹Ø°Ù‘Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø³Ù…Ù„Ø©ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù…Ø¨Ø§Ø´Ø±Ø©.", "error");
        playAyahAudio(currentAyahIndex, "tilawa");
    });

    audio.addEventListener("ended", () => {
        setTimeout(() => {
            if (mode === "tilawa") {
                updateProgress(1, ayahs.length);
                playAyahAudio(currentAyahIndex, "tilawa");
            }
        }, 1000);
    });
}

function hasSpeechSupport() {
    return "SpeechRecognition" in window || "webkitSpeechRecognition" in window;
}

function initRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return null;

    const rec = new SpeechRecognition();
    rec.lang = "ar-SA";
    rec.continuous = true;
    rec.interimResults = true;
    rec.maxAlternatives = 3;
    return rec;
}

function startTasmi() {
    if (!hasSpeechSupport()) {
        setStatus("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Web Speech API. Ø¬Ø±Ù‘Ø¨ Ù…ØªØµÙØ­ ÙƒØ±ÙˆÙ… Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯.", "error");
        return;
    }
    if (!currentSurah || !ayahs.length) {
        setStatus("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ø¶ØºØ· ØªØ³Ù…ÙŠØ¹.", "error");
        return;
    }

    stopCurrentAudio();
    cancelCountdown();
    stopRecognition();

    mode = "tasmi";
    enableMainControls(false);
    ayahInput.disabled = true;
    listeningDot.classList.add("active");
    recognizedBox.classList.add("active");
    recognizedText.textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹...";
    
    modeBadge.textContent = "ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ù…ÙŠØ¹ (Ø§Ø³ØªÙ…Ø§Ø¹)";
    modeBadge.className = "mode-badge mode-badge-tasmi";

    expectedAyahIndex = 0;
    updateProgress(expectedAyahIndex + 1, ayahs.length);

    ayahLabel.textContent = `Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¢ÙŠØ© ${expectedAyahIndex + 1}`;
    ayahTextBox.textContent = ayahs[expectedAyahIndex].text;

    console.log("ğŸ¤ Ø¨Ø¯Ø£ ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ù…ÙŠØ¹ - Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¢ÙŠØ© 1");
    startRecognition();
}

function startRecognition() {
    if (!recognition) {
        recognition = initRecognition();
        if (!recognition) {
            setStatus("ØªØ¹Ø°Ù‘Ø± ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.", "error");
            mode = "idle";
            enableMainControls(true);
            return;
        }

        recognition.onstart = () => {
            recognizing = true;
            listeningDot.classList.add("active");
            if (expectedAyahIndex < ayahs.length) {
                setStatus(`ğŸ¤ Ø§Ø³ØªÙ…Ø¹... Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¢ÙŠØ© ${expectedAyahIndex + 1}`, "strong");
            }
        };

        recognition.onerror = (event) => {
            console.error("speech error", event);
            if (event.error === "not-allowed") {
                setStatus("ØªÙ… Ø±ÙØ¶ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ÙØ¹Ù‘Ù„Ù‡Ø§ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.", "error");
                recognizedText.textContent = "âŒ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„";
            } else if (event.error === "no-speech") {
                recognizedText.textContent = "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù ØµÙˆØª";
            } else {
                setStatus("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª.", "warn");
            }
        };

        recognition.onend = () => {
            recognizing = false;
            listeningDot.classList.remove("active");
            
            if (mode === "tasmi" && expectedAyahIndex < ayahs.length) {
                setTimeout(() => {
                    if (mode === "tasmi" && expectedAyahIndex < ayahs.length) {
                        try {
                            recognition.start();
                            console.log("ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¢ÙŠØ©", expectedAyahIndex + 1);
                        } catch (e) {
                            console.warn("Recognition restart:", e);
                            startCountdown();
                        }
                    }
                }, 800);
            }
        };

        recognition.onresult = (event) => {
            let interimTranscript = "";
            let finalTranscript = "";
            
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                const res = event.results[i];
                if (res.isFinal) {
                    finalTranscript += res[0].transcript;
                } else {
                    interimTranscript += res[0].transcript;
                }
            }
            
            if (interimTranscript) {
                recognizedText.textContent = "ğŸ™ï¸ " + interimTranscript;
            }
            
            if (finalTranscript) {
                finalTranscript = finalTranscript.trim();
                recognizedText.textContent = "âœ… " + finalTranscript;
                processRecognizedText(finalTranscript);
            }
        };
    }

    try {
        recognition.start();
    } catch (e) {
        console.warn("Recognition already started", e);
    }
}

function stopRecognition() {
    if (recognition && recognizing) {
        try {
            recognition.stop();
        } catch (e) {}
    }
    recognizing = false;
    listeningDot.classList.remove("active");
}

function startCountdown() {
    cancelCountdown();
    if (mode !== "tasmi") return;
    
    const delaySec = parseInt(delayRange.value, 10) || 10;
    countdownSeconds = delaySec;

    if (expectedAyahIndex >= ayahs.length) {
        setStatus("ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ø³ÙˆØ±Ø©.", "done");
        modeBadge.textContent = "Ù…ÙƒØªÙ…Ù„";
        updateProgress(ayahs.length, ayahs.length);
        mode = "idle";
        enableMainControls(true);
        recognizedBox.classList.remove("active");
        return;
    }

    setStatus(`â±ï¸ ${countdownSeconds}Ø« - Ø¥Ø°Ø§ Ù„Ù… ØªÙ‚Ø±Ø£ Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢ÙŠØ© ${expectedAyahIndex + 1}`, "warn");
    console.log(`â±ï¸ Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ${countdownSeconds} Ø«Ø§Ù†ÙŠØ©`);

    countdownTimer = setInterval(() => {
        countdownSeconds--;
        if (countdownSeconds > 0) {
            setStatus(`â±ï¸ ${countdownSeconds}Ø« - Ø¥Ø°Ø§ Ù„Ù… ØªÙ‚Ø±Ø£ Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢ÙŠØ© ${expectedAyahIndex + 1}`, "warn");
        } else {
            cancelCountdown();
            if (mode === "tasmi" && expectedAyahIndex < ayahs.length) {
                console.log(`ğŸ”Š Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¹Ø¯ - Ø³ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢ÙŠØ© ${expectedAyahIndex + 1} (Ù„Ù… ÙŠÙ‚Ø±Ø£Ù‡Ø§ Ø§Ù„Ù‚Ø§Ø±Ø¦)`);
                stopRecognition();
                playAyahAudio(expectedAyahIndex, "tasmi");
            }
        }
    }, 1000);
}

function cancelCountdown() {
    if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
        console.log("â¹ï¸ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ");
    }
}

function processRecognizedText(text) {
    if (mode !== "tasmi" || !ayahs.length) return;

    const normInput = normalizeArabic(text);
    if (!normInput) return;

    if (isBasmala(text)) {
        console.log("ğŸ”¸ ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¨Ø³Ù…Ù„Ø©");
        recognizedText.innerHTML = `<div style="color: #facc15;">ğŸ”¸ Ø§Ù„Ø¨Ø³Ù…Ù„Ø© (Ù„Ø§ ØªÙØ­Ø³Ø¨)</div>`;
        return;
    }

    console.log("ğŸ¤ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙØªØ¹Ø±ÙÙ‘Ù Ø¹Ù„ÙŠÙ‡:", text);
    console.log("ğŸ” Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙØ¹Ø§Ù„Ø¬:", normInput);

    let bestScore = 0;
    let bestIndex = -1;
    let debugInfo = [];

    ayahs.forEach((a, idx) => {
        const score = calculateSimilarity(normInput, a.text);
        
        debugInfo.push({
            ayah: idx + 1,
            score: (score * 100).toFixed(1) + "%",
            expected: idx === expectedAyahIndex ? "âœ…" : ""
        });

        if (score > bestScore) {
            bestScore = score;
            bestIndex = idx;
        }
    });

    console.table(debugInfo.sort((a, b) => parseFloat(b.score) - parseFloat(a.score)).slice(0, 5));

    if (bestIndex >= 0 && bestScore >= 0.15) {
        const ayah = ayahs[bestIndex];
        
        if (bestIndex === expectedAyahIndex) {
            setStatus(`âœ… ØµØ­ÙŠØ­! Ø§Ù„Ø¢ÙŠØ© ${ayah.numberInSurah} (${(bestScore * 100).toFixed(0)}%)`, "strong");
            recognizedText.innerHTML = `<div style="color: #4ade80;">âœ… Ø§Ù„Ø¢ÙŠØ© ${ayah.numberInSurah} ØµØ­ÙŠØ­Ø© âœ“</div>`;
            
            expectedAyahIndex++;
            
            if (expectedAyahIndex < ayahs.length) {
                updateProgress(expectedAyahIndex + 1, ayahs.length);
                ayahLabel.textContent = `Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¢ÙŠØ© ${expectedAyahIndex + 1}`;
                ayahTextBox.textContent = ayahs[expectedAyahIndex].text;
                console.log(`âœ… Ù‚Ø±Ø£ Ø§Ù„Ø¢ÙŠØ© ${ayah.numberInSurah} ØµØ­ÙŠØ­Ø© - Ø§Ù„Ø¢Ù† Ù†Ù†ØªØ¸Ø± Ø§Ù„Ø¢ÙŠØ© ${expectedAyahIndex + 1}`);
                
            } else {
                updateProgress(ayahs.length, ayahs.length);
                setStatus("ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ø³ÙˆØ±Ø©.", "done");
                modeBadge.textContent = "Ù…ÙƒØªÙ…Ù„";
                mode = "idle";
                enableMainControls(true);
                recognizedBox.classList.remove("active");
                stopRecognition();
            }
            
        } else if (bestIndex > expectedAyahIndex && bestIndex <= expectedAyahIndex + 2) {
            recognizedText.innerHTML = `<div style="color: #facc15;">âš ï¸ Ù‚ÙØ²Øª Ù…Ù† ${expectedAyahIndex + 1} Ø¥Ù„Ù‰ ${ayah.numberInSurah}</div>`;
            setStatus(`âš ï¸ Ù‚ÙØ²Øª Ø¥Ù„Ù‰ Ø§Ù„Ø¢ÙŠØ© ${ayah.numberInSurah}`, "warn");
            
            expectedAyahIndex = bestIndex + 1;
            
            if (expectedAyahIndex < ayahs.length) {
                updateProgress(expectedAyahIndex + 1, ayahs.length);
                ayahLabel.textContent = `Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¢ÙŠØ© ${expectedAyahIndex + 1}`;
                ayahTextBox.textContent = ayahs[expectedAyahIndex].text;
            } else {
                updateProgress(ayahs.length, ayahs.length);
            }
            
        } else {
            recognizedText.innerHTML = `<div style="color: #f87171;">âŒ Ø§Ù„Ø¢ÙŠØ© ${ayah.numberInSurah} ÙˆÙ„ÙŠØ³Øª ${expectedAyahIndex + 1}</div>`;
            setStatus(`âš ï¸ Ø§Ù„Ø¢ÙŠØ© ${ayah.numberInSurah} â‰  ${expectedAyahIndex + 1}`, "error");
        }
    } else {
        if (bestScore >= 0.10) {
            recognizedText.innerHTML = `<div style="color: #facc15; font-size: 0.75rem;">âš ï¸ ${(bestScore * 100).toFixed(0)}% - Ø±Ø¨Ù…Ø§ Ø¢ÙŠØ© ${bestIndex + 1}ØŸ</div>`;
        } else {
            recognizedText.innerHTML = `<div style="color: #9ca3af; font-size: 0.7rem;">ğŸ™ï¸ Ø§Ø³ØªÙ…Ø± Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©...</div>`;
        }
        console.warn("âš ï¸ ØªØ·Ø§Ø¨Ù‚ Ø¶Ø¹ÙŠÙ - Ø£ÙØ¶Ù„ ØªØ·Ø§Ø¨Ù‚:", (bestScore * 100).toFixed(1) + "%", "Ù„Ù„Ø¢ÙŠØ©", bestIndex + 1);
    }
}

function setStatus(text, level = "normal") {
    statusMessage.textContent = text;
    statusMessage.className = "status";
    if (level === "strong") statusMessage.classList.add("status-strong");
    else if (level === "warn") statusMessage.classList.add("status-warn");
    else if (level === "info") statusMessage.classList.add("status-info");
    else if (level === "done") statusMessage.classList.add("status-done");
    else if (level === "error") statusMessage.classList.add("status-error");
}

function enableMainControls(enabled) {
    btnTasmi.disabled = !enabled;
    btnTilawa.disabled = !enabled;
    btnStop.disabled = false;
    surahSelect.disabled = !enabled;
    reciterSelect.disabled = !enabled;
}

delayRange.addEventListener("input", () => {
    delayValue.textContent = `Ù…Ø¯Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: ${delayRange.value} Ø«Ø§Ù†ÙŠØ©`;
});

surahSelect.addEventListener("change", async () => {
    const val = surahSelect.value;
    if (!val) {
        currentSurah = null;
        ayahs = [];
        updateProgress(0, 0);
        ayahLabel.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢ÙŠØ© Ù…Ø¹Ø±ÙˆØ¶Ø©";
        ayahTextBox.textContent = "";
        setStatus("Ø§Ø®ØªØ± Ø³ÙˆØ±Ø© Ù„Ù„Ø¨Ø¯Ø¡.", "normal");
        return;
    }
    await loadSurah(val);
});

reciterSelect.addEventListener("change", async () => {
    currentAudioEdition = reciterSelect.value;
    if (mode === "idle" && currentSurah) {
        await loadSurah(currentSurah);
    } else {
        setStatus("Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø© Ø£Ùˆ Ø¨Ø¯Ø¡ ÙˆØ¶Ø¹ Ø¬Ø¯ÙŠØ¯.", "info");
    }
});

btnTilawa.addEventListener("click", () => {
    if (!surahSelect.value) {
        setStatus("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.", "error");
        return;
    }
    startTilawa();
});

btnTasmi.addEventListener("click", () => {
    if (!surahSelect.value) {
        setStatus("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.", "error");
        return;
    }
    startTasmi();
});

btnStop.addEventListener("click", () => {
    mode = "idle";
    stopCurrentAudio();
    stopRecognition();
    cancelCountdown();
    enableMainControls(true);
    ayahInput.disabled = false;

    listeningDot.classList.remove("active");
    recognizedBox.classList.remove("active");
    modeBadge.textContent = "ÙˆØ¶Ø¹ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„";
    modeBadge.className = "mode-badge";

    setStatus("ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø³ÙˆØ±Ø© Ø£Ùˆ ÙˆØ¶Ø¹ Ø¬Ø¯ÙŠØ¯.", "normal");
});

document.addEventListener("DOMContentLoaded", () => {
    loadSurahList();
});
</script>
</body>
</html>
