<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <title>ØªØ³Ù…ÙŠØ¹ ÙˆØªÙ„Ø§ÙˆØ© Ø§Ù„Ù‚Ø±Ø¢Ù†</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <style>
        :root {
            --bg: #050b10;
            --card-bg: #111827;
            --accent: #22c55e;      /* Ø£Ø®Ø¶Ø± */
            --accent-light: #4ade80;/* Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ (Ø§Ø³ØªÙ…Ø§Ø¹) */
            --accent-blue: #3b82f6; /* Ø£Ø²Ø±Ù‚ (ØªØ´ØºÙŠÙ„ ÙÙŠ Ø§Ù„ØªØ³Ù…ÙŠØ¹) */
            --accent-yellow: #eab308;/* Ø£ØµÙØ± (Ø§Ù†ØªØ¸Ø§Ø± / Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„) */
            --text-main: #f9fafb;
            --text-sub: #9ca3af;
            --border: #1f2933;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #0f172a 0, #020617 60%);
            color: var(--text-main);
        }

        .app {
            max-width: 480px;
            margin: 0 auto;
            padding: 1rem 0.8rem 1.5rem;
        }

        .card {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 18px;
            padding: 1rem 0.8rem 1.2rem;
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.15);
            backdrop-filter: blur(12px);
        }

        h1 {
            font-size: 1.3rem;
            margin: 0 0 0.25rem;
            text-align: center;
        }

        .subtitle {
            font-size: 0.8rem;
            text-align: center;
            color: var(--text-sub);
            margin-bottom: 0.8rem;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .field {
            flex: 1 1 100%;
        }

        .field-half {
            flex: 1 1 calc(50% - 0.25rem);
        }

        label {
            display: block;
            font-size: 0.78rem;
            margin-bottom: 0.15rem;
            color: var(--text-sub);
        }

        select,
        input[type="number"],
        input[type="range"] {
            width: 100%;
            padding: 0.45rem 0.5rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #020617;
            color: var(--text-main);
            font-size: 0.9rem;
        }

        select:disabled,
        input:disabled {
            opacity: 0.6;
        }

        .range-value {
            font-size: 0.8rem;
            color: var(--text-sub);
            text-align: left;
            margin-top: 0.15rem;
        }

        .buttons {
            display: flex;
            gap: 0.4rem;
            margin: 0.7rem 0 0.3rem;
        }

        .btn {
            flex: 1 1 0;
            border: none;
            border-radius: 999px;
            padding: 0.55rem 0.4rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease, opacity 0.1s ease;
        }

        .btn span.emoji {
            font-size: 1.05rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #16a34a, #22c55e);
            color: #ecfdf5;
            box-shadow: 0 8px 18px rgba(34, 197, 94, 0.40);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #0ea5e9, #3b82f6);
            color: #eff6ff;
            box-shadow: 0 8px 18px rgba(59, 130, 246, 0.40);
        }

        .btn-stop {
            background: linear-gradient(135deg, #dc2626, #f97316);
            color: #fef2f2;
            box-shadow: 0 8px 18px rgba(239, 68, 68, 0.40);
        }

        .btn:disabled {
            opacity: 0.35;
            cursor: default;
            transform: none;
            box-shadow: none;
        }

        .btn:not(:disabled):active {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
        }

        .status-row {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.4rem;
        }

        .status {
            flex: 1;
            font-size: 0.82rem;
            min-height: 1.1rem;
            color: var(--text-sub);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-strong {
            color: var(--accent);
        }
        .status-warn {
            color: var(--accent-yellow);
        }
        .status-info {
            color: var(--accent-blue);
        }
        .status-done {
            color: #facc15;
            font-weight: 600;
        }
        .status-error {
            color: var(--danger);
        }

        .listening-indicator {
            width: 14px;
            height: 14px;
            border-radius: 999px;
            border: 2px solid rgba(74, 222, 128, 0.5);
            box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4);
            transform: scale(1);
            opacity: 0;
        }

        .listening-indicator.active {
            background: var(--accent-light);
            opacity: 1;
            animation: pulse 1.4s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4);
            }
            70% {
                transform: scale(1.4);
                box-shadow: 0 0 0 12px rgba(74, 222, 128, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
            }
        }

        .progress-wrapper {
            margin-top: 0.8rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.18);
        }

        .progress-bar-inner {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #84cc16);
            transition: width 0.2s ease;
        }

        .progress-text {
            margin-top: 0.25rem;
            font-size: 0.8rem;
            color: var(--text-sub);
            display: flex;
            justify-content: space-between;
        }

        .ayah-box {
            margin-top: 0.8rem;
            border-radius: 14px;
            padding: 0.6rem 0.6rem 0.5rem;
            background: radial-gradient(circle at top right, rgba(22, 163, 74, 0.15), rgba(15, 23, 42, 0.95));
            border: 1px solid rgba(148, 163, 184, 0.18);
            min-height: 3.1rem;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .ayah-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.78rem;
            color: var(--text-sub);
        }

        .ayah-text {
            font-size: 1.02rem;
            line-height: 1.7;
            word-spacing: 0.15em;
            text-align: justify;
        }

        .ayah-word {
            display: inline-block;
            padding: 0 0.12rem;
            border-radius: 6px;
            transition: background 0.12s ease, color 0.12s ease, transform 0.12s ease;
        }

        .ayah-word.active-tilawa {
            background: rgba(34, 197, 94, 0.25);
            color: #bbf7d0;
            transform: translateY(-1px);
        }

        .ayah-word.active-tasmi {
            background: rgba(59, 130, 246, 0.30);
            color: #dbeafe;
            transform: translateY(-1px);
        }

        .mode-badge {
            font-size: 0.72rem;
            padding: 0.12rem 0.4rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: var(--text-sub);
        }

        .mode-badge-tilawa {
            border-color: rgba(34, 197, 94, 0.6);
            color: #bbf7d0;
        }
        .mode-badge-tasmi {
            border-color: rgba(59, 130, 246, 0.6);
            color: #bfdbfe;
        }

        .footer-note {
            margin-top: 0.7rem;
            font-size: 0.72rem;
            color: var(--text-sub);
            text-align: center;
        }

        @media (min-width: 520px) {
            .app {
                padding-top: 1.5rem;
            }
            .card {
                padding: 1.2rem 1.1rem 1.3rem;
            }
        }
    </style>
</head>
<body>
<div class="app">
    <div class="card">
        <h1>Ù…Ø³Ø§Ø¹Ø¯ ØªØ³Ù…ÙŠØ¹ ÙˆØªÙ„Ø§ÙˆØ© Ø§Ù„Ù‚Ø±Ø¢Ù†</h1>
        <div class="subtitle">ÙŠØ³Ù…Ø¹ Ù‚Ø±Ø§Ø¡ØªÙƒ ğŸ¤ ÙˆÙŠØ´ØºÙ‘Ù„ Ù„Ùƒ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© ğŸ“– ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div>

        <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div class="row">
            <div class="field">
                <label for="surahSelect">Ø§Ù„Ø³ÙˆØ±Ø© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
                <select id="surahSelect">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø©...</option>
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ 114 Ø³ÙˆØ±Ø© Ù…Ù† API -->
                </select>
            </div>

            <div class="field-half">
                <label for="ayahInput">Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© (Ù„Ù„ØªÙ„Ø§ÙˆØ© ÙÙ‚Ø·)</label>
                <input id="ayahInput" type="number" min="1" placeholder="Ù…Ø«Ù„Ø§Ù‹: 1" />
            </div>

            <div class="field-half">
                <label for="reciterSelect">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø±Ø¦</label>
                <select id="reciterSelect">
                    <!-- ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ù…Ù† ÙˆØ«Ø§Ø¦Ù‚ API alquran.cloud -->
                    <option value="ar.alafasy">Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ</option>
                    <!-- ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø­ØªÙ‰ 10 Ù‚Ø±Ù‘Ø§Ø¡ Ù‡Ù†Ø§ -->
                </select>
            </div>

            <div class="field">
                <label for="delayRange">Ù…Ù†Ø²Ù„Ù‚ Ø§Ù„ØªØ£Ø®ÙŠØ± Ù‚Ø¨Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙŠ Ø§Ù„ØªØ³Ù…ÙŠØ¹ (Ø«ÙˆØ§Ù†Ù)</label>
                <input id="delayRange" type="range" min="5" max="20" step="1" value="10" />
                <div id="delayValue" class="range-value">Ù…Ø¯Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: 10 Ø«Ø§Ù†ÙŠØ©</div>
            </div>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
        <div class="buttons">
            <button id="btnTasmi" class="btn btn-primary">
                <span class="emoji">ğŸ¤</span><span>ØªØ³Ù…ÙŠØ¹</span>
            </button>
            <button id="btnTilawa" class="btn btn-secondary">
                <span class="emoji">ğŸ“–</span><span>ØªÙ„Ø§ÙˆØ©</span>
            </button>
            <button id="btnStop" class="btn btn-stop">
                <span class="emoji">â¹ï¸</span><span>Ø¥ÙŠÙ‚Ø§Ù</span>
            </button>
        </div>

        <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… -->
        <div class="status-row">
            <div id="listeningDot" class="listening-indicator"></div>
            <div id="statusMessage" class="status">Ø¬Ø§Ù‡Ø² Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙˆØ±Ø©</div>
        </div>

        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
        <div class="progress-wrapper">
            <div class="progress-bar">
                <div id="progressInner" class="progress-bar-inner"></div>
            </div>
            <div class="progress-text">
                <span id="progressAyah">Ø§Ù„Ø¢ÙŠØ©: - / -</span>
                <span id="progressPercent">0%</span>
            </div>
        </div>

        <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø¢ÙŠØ© ÙˆØ§Ù„ÙƒÙ„Ù…Ø§Øª -->
        <div class="ayah-box">
            <div class="ayah-header">
                <span id="ayahLabel">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢ÙŠØ© Ù…Ø¹Ø±ÙˆØ¶Ø©</span>
                <span id="modeBadge" class="mode-badge">ÙˆØ¶Ø¹ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„</span>
            </div>
            <div id="ayahText" class="ayah-text"></div>
        </div>

        <div class="footer-note">
            ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Web Speech API (ØªØ¹Ù…Ù„ Ø£ÙØ¶Ù„ ÙÙŠ Ù…ØªØµÙØ­ ÙƒØ±ÙˆÙ…) ÙˆØ¹Ù„Ù‰ Ø®Ø¯Ù…Ø© alquran.cloud Ù„Ù†ØµÙˆØµ ÙˆØ£ØµÙˆØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†.
        </div>
    </div>
</div>

<script>
/* =========================
   Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„Ù…ØªØºÙŠÙ‘Ø±Ø§Øª
   ========================= */

const API_BASE = "https://api.alquran.cloud/v1"; // [web:7][web:10][web:19][web:22]
const DEFAULT_TEXT_EDITION = "quran-uthmani";
let currentAudioEdition = "ar.alafasy";          // [web:25]

const surahSelect = document.getElementById("surahSelect");
const ayahInput = document.getElementById("ayahInput");
const reciterSelect = document.getElementById("reciterSelect");
const delayRange = document.getElementById("delayRange");
const delayValue = document.getElementById("delayValue");
const btnTasmi = document.getElementById("btnTasmi");
const btnTilawa = document.getElementById("btnTilawa");
const btnStop = document.getElementById("btnStop");

const statusMessage = document.getElementById("statusMessage");
const listeningDot = document.getElementById("listeningDot");
const progressInner = document.getElementById("progressInner");
const progressAyah = document.getElementById("progressAyah");
const progressPercent = document.getElementById("progressPercent");
const ayahLabel = document.getElementById("ayahLabel");
const ayahTextBox = document.getElementById("ayahText");
const modeBadge = document.getElementById("modeBadge");

// Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
let mode = "idle";           // idle | tasmi | tilawa
let currentSurah = null;     // Ø±Ù‚Ù… Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ
let ayahs = [];              // [{ numberInSurah, text, normalizedText, audioUrl }, ...]
let currentAyahIndex = -1;   // Ù…Ø¤Ø´Ø± Ø§Ù„Ø¢ÙŠØ© (0-based)
let nextAyahToPlayIndex = 0; // Ø®Ø§Øµ Ø¨Ø§Ù„ØªØ³Ù…ÙŠØ¹ (Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù„ØªØ´ØºÙŠÙ„)
let recognition = null;
let recognizing = false;
let countdownTimer = null;
let countdownSeconds = 0;
let currentAudio = null;
let wordTimer = null;

/* =========================
   Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
   ========================= */

function normalizeArabic(text) {
    if (!text) return "";
    let t = text;
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„
    t = t.replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06ED]/g, "");
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ·ÙˆÙŠÙ„
    t = t.replace(/Ù€/g, "");
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
    t = t.replace(/[\d\u0660-\u0669]/g, "");
    t = t.replace(/[^\u0600-\u06FF\s]/g, " ");
    // Ù…Ø³Ø§ÙØ§Øª
    t = t.replace(/\s+/g, " ").trim();
    return t;
}

function splitWords(text) {
    const clean = text.replace(/\s+/g, " ").trim();
    return clean ? clean.split(" ") : [];
}

/* =========================
   ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ± ÙˆØ§Ù„Ø¢ÙŠØ§Øª ÙˆØ§Ù„ØµÙˆØª
   ========================= */

async function loadSurahList() {
    try {
        setStatus("Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ±...", "info");
        const resp = await fetch(API_BASE + "/surahs"); // ÙŠØ±Ø¬Ø¹ 114 Ø³ÙˆØ±Ø© [web:10]
        const json = await resp.json();
        if (json.code !== 200) throw new Error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±");
        surahSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø©...</option>';
        json.data.forEach((s) => {
            const opt = document.createElement("option");
            opt.value = s.number;
            opt.textContent = `${s.number}. ${s.englishName} - ${s.name}`;
            opt.dataset.ayahs = s.numberOfAyahs;
            surahSelect.appendChild(opt);
        });
        setStatus("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¶Ø¹: ØªØ³Ù…ÙŠØ¹ Ø£Ùˆ ØªÙ„Ø§ÙˆØ©", "normal");
    } catch (e) {
        console.error(e);
        setStatus("ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.", "error");
    }
}

async function loadSurah(surahNumber) {
    if (!surahNumber) return;
    try {
        setStatus("Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ù†ØµÙˆØµ ÙˆØ¢ÙŠØ§Øª Ø§Ù„Ø³ÙˆØ±Ø©...", "info");
        ayahs = [];
        currentSurah = null;

        // Ù†Øµ Ø§Ù„Ø¢ÙŠØ§Øª
        const textUrl = `${API_BASE}/surah/${surahNumber}/${DEFAULT_TEXT_EDITION}`;
        const audioUrl = `${API_BASE}/surah/${surahNumber}/${currentAudioEdition}`;

        const [textResp, audioResp] = await Promise.all([
            fetch(textUrl),
            fetch(audioUrl),
        ]);

        const [textJson, audioJson] = await Promise.all([
            textResp.json(),
            audioResp.json(),
        ]);

        if (textJson.code !== 200 || audioJson.code !== 200) {
            throw new Error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…");
        }

        const textAyahs = textJson.data.ayahs;
        const audioAyahs = audioJson.data.ayahs;

        ayahs = textAyahs.map((a, idx) => {
            const audioAyah = audioAyahs[idx] || {};
            return {
                numberInSurah: a.numberInSurah,
                text: a.text,
                normalizedText: normalizeArabic(a.text),
                audioUrl: audioAyah.audio || "",
            };
        });

        currentSurah = surahNumber;
        currentAyahIndex = -1;
        nextAyahToPlayIndex = 0;

        updateProgress(0, ayahs.length);
        ayahLabel.textContent = "Ø§Ù„Ø³ÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø©";
        ayahTextBox.textContent = "Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ù…ÙŠØ¹ Ø£Ùˆ Ø§Ù„ØªÙ„Ø§ÙˆØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¢ÙŠØ§Øª.";

        setStatus("Ø§Ù„Ø³ÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø© âœ”ï¸", "strong");
    } catch (e) {
        console.error(e);
        setStatus("ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.", "error");
    }
}

/* =========================
   Ø¥Ø¯Ø§Ø±Ø© Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
   ========================= */

function updateProgress(currentIndex, total) {
    const curr = currentIndex > 0 ? currentIndex : 0;
    const percent = total > 0 ? Math.round((curr / total) * 100) : 0;
    progressInner.style.width = percent + "%";
    progressAyah.textContent = `Ø§Ù„Ø¢ÙŠØ©: ${curr} / ${total || "-"}`;
    progressPercent.textContent = percent + "%";
}

/* =========================
   Ø¹Ø±Ø¶ Ø§Ù„Ø¢ÙŠØ© ÙˆØ§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
   ========================= */

function clearWordHighlight() {
    if (wordTimer) {
        clearInterval(wordTimer);
        wordTimer = null;
    }
}

function renderAyahWords(ayahText) {
    clearWordHighlight();
    ayahTextBox.innerHTML = "";
    if (!ayahText) return;

    const words = splitWords(ayahText);
    words.forEach((w, idx) => {
        const span = document.createElement("span");
        span.textContent = w + " ";
        span.className = "ayah-word";
        span.dataset.index = idx;
        ayahTextBox.appendChild(span);
    });
}

function animateWordsWithAudio(audio, modeKind) {
    clearWordHighlight();

    const spans = Array.from(document.querySelectorAll(".ayah-word"));
    if (!spans.length || !audio) return;

    const activeClass =
        modeKind === "tilawa" ? "active-tilawa" : "active-tasmi";

    function clearActive() {
        spans.forEach((s) => s.classList.remove("active-tilawa", "active-tasmi"));
    }

    let idx = 0;
    const startAnimation = () => {
        clearActive();
        const duration = audio.duration || 10; // Ø§ÙØªØ±Ø§Ø¶ÙŠ 10 Ø«ÙˆØ§Ù†Ù Ø¥Ù† Ù„Ù… ØªÙØ¹Ø±Ù Ø§Ù„Ù…Ø¯Ø©
        const step = duration / (spans.length || 1);

        wordTimer = setInterval(() => {
            clearActive();
            if (idx >= spans.length) {
                clearInterval(wordTimer);
                wordTimer = null;
                return;
            }
            spans[idx].classList.add(activeClass);
            idx++;
        }, step * 1000);
    };

    if (audio.readyState >= 1) {
        startAnimation();
    } else {
        audio.addEventListener(
            "loadedmetadata",
            () => {
                startAnimation();
            },
            { once: true }
        );
    }

    audio.addEventListener(
        "ended",
        () => {
            clearActive();
            clearWordHighlight();
        },
        { once: false }
    );
}

/* =========================
   ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ù„Ø¢ÙŠØ©
   ========================= */

function stopCurrentAudio() {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }
    clearWordHighlight();
}

function playAyahAudio(index, playMode) {
    if (!ayahs.length || index < 0 || index >= ayahs.length) return;

    const ayah = ayahs[index];
    if (!ayah.audioUrl) {
        setStatus("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ØµÙˆØª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¢ÙŠØ© ÙÙŠ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ.", "error");
        return;
    }

    stopCurrentAudio();

    const audio = new Audio(ayah.audioUrl);
    currentAudio = audio;

    ayahLabel.textContent = `Ø§Ù„Ø¢ÙŠØ© ${ayah.numberInSurah}`;
    renderAyahWords(ayah.text);
    animateWordsWithAudio(audio, playMode);

    // Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„Ø©
    if (playMode === "tilawa") {
        setStatus(`ğŸ“– ØªÙ„Ø§ÙˆØ© Ø¢ÙŠØ© ${ayah.numberInSurah}`, "strong");
        modeBadge.textContent = "ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ø§ÙˆØ©";
        modeBadge.className = "mode-badge mode-badge-tilawa";
    } else {
        setStatus(`ğŸ“» ØªØ´ØºÙŠÙ„ Ø¢ÙŠØ© ${ayah.numberInSurah}`, "info");
        modeBadge.textContent = "ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ù…ÙŠØ¹ (ØªØ´ØºÙŠÙ„)";
        modeBadge.className = "mode-badge mode-badge-tasmi";
    }

    audio.play().catch((e) => {
        console.error(e);
        setStatus("ØªØ¹Ø°Ù‘Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ØµÙˆØª.", "error");
    });

    // Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¢ÙŠØ©
    audio.addEventListener("ended", () => {
        if (playMode === "tilawa") {
            // Ø¨Ø¹Ø¯ 1.2 Ø«Ø§Ù†ÙŠØ© Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
            setTimeout(() => {
                if (mode === "tilawa") {
                    currentAyahIndex++;
                    if (currentAyahIndex >= ayahs.length) {
                        setStatus("ğŸ‰ Ø¥ÙƒÙ…Ø§Ù„! Ø§Ù†ØªÙ‡ÙŠØª Ù…Ù† Ø§Ù„Ø³ÙˆØ±Ø©.", "done");
                        modeBadge.textContent = "Ù…ÙƒØªÙ…Ù„";
                        updateProgress(ayahs.length, ayahs.length);
                        mode = "idle";
                        enableMainControls(true);
                    } else {
                        updateProgress(currentAyahIndex + 1, ayahs.length);
                        playAyahAudio(currentAyahIndex, "tilawa");
                    }
                }
            }, 1200);
        } else if (playMode === "tasmi") {
            // Ø¨Ø¹Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙŠØ¹ÙˆØ¯ Ù„Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
            if (mode === "tasmi") {
                startRecognition();
            }
        }
    });
}

/* =========================
   ØªØ³Ù„Ø³Ù„ Ø§Ù„ØªÙ„Ø§ÙˆØ© (ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ø§ÙˆØ©)
   ========================= */

function startTilawa() {
    if (!currentSurah || !ayahs.length) {
        setStatus("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹ØŒ ÙŠØªÙ… Ø¨Ø¹Ø¯Ù‡Ø§ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢ÙŠØ§Øª.", "error");
        return;
    }
    stopCurrentAudio();
    cancelCountdown();
    stopRecognition();

    mode = "tilawa";
    enableMainControls(false);
    ayahInput.disabled = false; // ÙÙŠ Ø§Ù„ØªÙ„Ø§ÙˆØ© ÙÙ‚Ø·
    listeningDot.classList.remove("active");

    const total = ayahs.length;
    let startIndex = 0;

    const desiredAyah = parseInt(ayahInput.value, 10);
    if (!isNaN(desiredAyah) && desiredAyah >= 1 && desiredAyah <= total) {
        startIndex = desiredAyah - 1;
    }

    currentAyahIndex = startIndex;
    updateProgress(currentAyahIndex, total);

    // Ø§Ù„Ø¨Ø³Ù…Ù„Ø©: Ø¥Ø°Ø§ Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø¢ÙŠØ© 1 ÙˆØ§Ù„Ø³ÙˆØ±Ø© Ù„ÙŠØ³Øª Ø§Ù„ØªÙˆØ¨Ø© (9)
    if (currentSurah !== "9" && currentAyahIndex === 0) {
        // ØªØ´ØºÙŠÙ„ Ø¨Ø³Ù…Ù„Ø© Ø®Ø§ØµØ© Ø«Ù… Ø£ÙˆÙ„ Ø¢ÙŠØ©
        playBasmalaThenFirstAyah();
    } else {
        playAyahAudio(currentAyahIndex, "tilawa");
    }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø³Ù…Ù„Ø© (Ù…Ù† Ø¢ÙŠØ© Ø±Ù‚Ù… 1 ÙÙŠ Ø§Ù„Ù…ØµØ­Ù) Ø¨ØµÙˆØª Ø§Ù„Ù‚Ø§Ø±Ø¦ØŒ Ø«Ù… Ø¢ÙŠØ© 1 Ù…Ù† Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
function playBasmalaThenFirstAyah() {
    stopCurrentAudio();

    const basmalaUrl =
        "https://cdn.islamic.network/quran/audio/128/" +
        currentAudioEdition +
        "/1.mp3"; // Ø¢ÙŠØ© 1 = Ø§Ù„Ø¨Ø³Ù…Ù„Ø© [web:25]

    const audio = new Audio(basmalaUrl);
    currentAudio = audio;

    const basmalaText = "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø§Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù";
    ayahLabel.textContent = "Ø§Ù„Ø¨Ø³Ù…Ù„Ø©";
    renderAyahWords(basmalaText);
    animateWordsWithAudio(audio, "tilawa");

    setStatus("ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø³Ù…Ù„Ø©...", "strong");
    modeBadge.textContent = "ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ø§ÙˆØ©";
    modeBadge.className = "mode-badge mode-badge-tilawa";

    audio.play().catch((e) => {
        console.error(e);
        setStatus("ØªØ¹Ø°Ù‘Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø³Ù…Ù„Ø©ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù…Ø¨Ø§Ø´Ø±Ø©.", "error");
        // Ø§Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
        playAyahAudio(currentAyahIndex, "tilawa");
    });

    audio.addEventListener("ended", () => {
        // Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙŠØ°Ù‡Ø¨ Ù„Ù„Ø¢ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰
        setTimeout(() => {
            if (mode === "tilawa") {
                playAyahAudio(currentAyahIndex, "tilawa");
            }
        }, 1000);
    });
}

/* =========================
   Web Speech API (ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ù…ÙŠØ¹)
   ========================= */

function hasSpeechSupport() {
    return (
        "SpeechRecognition" in window ||
        "webkitSpeechRecognition" in window
    );
}

function initRecognition() {
    const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return null;

    const rec = new SpeechRecognition();
    rec.lang = "ar-SA";
    rec.continuous = true;
    rec.interimResults = true;
    return rec;
}

function startTasmi() {
    if (!hasSpeechSupport()) {
        setStatus(
            "Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Web Speech API. Ø¬Ø±Ù‘Ø¨ Ù…ØªØµÙØ­ ÙƒØ±ÙˆÙ… Ø¹Ù„Ù‰ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯.",
            "error"
        );
        return;
    }
    if (!currentSurah || !ayahs.length) {
        setStatus("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ø¶ØºØ· ØªØ³Ù…ÙŠØ¹.", "error");
        return;
    }

    stopCurrentAudio();
    cancelCountdown();
    stopRecognition();

    mode = "tasmi";
    enableMainControls(false);
    ayahInput.disabled = true; // ÙÙŠ Ø§Ù„ØªØ³Ù…ÙŠØ¹ ÙŠÙƒÙˆÙ† Ù…Ø¹Ø·Ù„Ø§Ù‹
    listeningDot.classList.add("active");
    modeBadge.textContent = "ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ù…ÙŠØ¹ (Ø§Ø³ØªÙ…Ø§Ø¹)";
    modeBadge.className = "mode-badge mode-badge-tasmi";

    nextAyahToPlayIndex = 0; // Ø³ÙŠØ­Ø¯Ù‘ÙØ« Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø±Ù
    updateProgress(0, ayahs.length);

    startRecognition();
}

function startRecognition() {
    if (!recognition) {
        recognition = initRecognition();
        if (!recognition) {
            setStatus(
                "ØªØ¹Ø°Ù‘Ø± ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.",
                "error"
            );
            mode = "idle";
            enableMainControls(true);
            return;
        }

        recognition.onstart = () => {
            recognizing = true;
            listeningDot.classList.add("active");
            setStatus("ğŸ¤ Ø§Ø³ØªÙ…Ø¹... Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©", "strong");
        };

        recognition.onerror = (event) => {
            console.error("speech error", event);
            if (event.error === "not-allowed") {
                setStatus("ØªÙ… Ø±ÙØ¶ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ÙØ¹Ù‘Ù„Ù‡Ø§ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­.", "error");
            } else {
                setStatus("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØªØŒ Ø³ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "error");
            }
        };

        recognition.onend = () => {
            recognizing = false;
            listeningDot.classList.remove("active");
            // Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙƒÙ„Ø§Ù… â†’ Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
            if (mode === "tasmi") {
                startCountdown();
            }
        };

        recognition.onresult = (event) => {
            let finalTranscript = "";
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                const res = event.results[i];
                if (res.isFinal) {
                    finalTranscript += res[0].transcript;
                }
            }
            finalTranscript = finalTranscript.trim();
            if (finalTranscript) {
                processRecognizedText(finalTranscript);
            }
        };
    }

    try {
        recognition.start();
    } catch (e) {
        // ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§ØªØŒ start Ù…Ø±ØªÙŠÙ† ØªØ±Ù…ÙŠ Ø§Ø³ØªØ«Ù†Ø§Ø¡ØŒ Ù†ØªØ¬Ø§Ù‡Ù„Ù‡
    }
}

function stopRecognition() {
    if (recognition && recognizing) {
        try {
            recognition.stop();
        } catch (e) {}
    }
    recognizing = false;
    listeningDot.classList.remove("active");
}

function startCountdown() {
    cancelCountdown();
    if (mode !== "tasmi") return;
    const delaySec = parseInt(delayRange.value, 10) || 10;
    countdownSeconds = delaySec;

    setStatus(`â±ï¸ ${countdownSeconds}Ø« Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„`, "warn");

    countdownTimer = setInterval(() => {
        countdownSeconds--;
        if (countdownSeconds > 0) {
            setStatus(`â±ï¸ ${countdownSeconds}Ø« Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„`, "warn");
        } else {
            cancelCountdown();
            // Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ø¯ â†’ Ù†ÙØ´ØºÙ‘Ù„ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø§Ù„ØªÙŠ Ù„Ù… ØªÙÙ‚Ø±Ø£ Ø¨Ø¹Ø¯
            if (mode === "tasmi") {
                if (nextAyahToPlayIndex >= 0 && nextAyahToPlayIndex < ayahs.length) {
                    playAyahAudio(nextAyahToPlayIndex, "tasmi");
                } else {
                    setStatus("ğŸ‰ ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ø³ÙˆØ±Ø© ÙÙŠ Ø§Ù„ØªØ³Ù…ÙŠØ¹.", "done");
                    modeBadge.textContent = "Ù…ÙƒØªÙ…Ù„";
                    updateProgress(ayahs.length, ayahs.length);
                    mode = "idle";
                    enableMainControls(true);
                }
            }
        }
    }, 1000);
}

function cancelCountdown() {
    if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
    }
}

/* Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡ Ù…Ø¹ Ø¢ÙŠØ§Øª Ø§Ù„Ø³ÙˆØ±Ø© (ØªØ·Ø§Ø¨Ù‚ Ø°ÙƒÙŠ 50%+) */
function processRecognizedText(text) {
    if (mode !== "tasmi" || !ayahs.length) return;

    const normInput = normalizeArabic(text);
    if (!normInput) return;

    const inputWords = splitWords(normInput);
    if (!inputWords.length) return;

    let bestScore = 0;
    let bestIndex = -1;

    ayahs.forEach((a, idx) => {
        const ayahWords = splitWords(a.normalizedText);
        if (!ayahWords.length) return;

        let matches = 0;
        const ayahWordSet = new Set(ayahWords);
        inputWords.forEach((w) => {
            if (ayahWordSet.has(w)) matches++;
        });

        const score = matches / Math.max(ayahWords.length, inputWords.length);
        if (score > bestScore) {
            bestScore = score;
            bestIndex = idx;
        }
    });

    if (bestIndex >= 0 && bestScore >= 0.5) {
        const ayah = ayahs[bestIndex];
        setStatus(`âœ… Ø¢ÙŠØ© Ø±Ù‚Ù… ${ayah.numberInSurah} (ØªØ·Ø§Ø¨Ù‚ ${(bestScore * 100).toFixed(0)}%)`, "strong");

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù‘Ù… (Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¢ÙŠØ§Øª)
        updateProgress(ayah.numberInSurah, ayahs.length);

        // Ø­ÙØ¸ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© X+1 Ù„ÙŠÙ‚ÙˆÙ… Ø¨ØªØ´ØºÙŠÙ„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
        const next = bestIndex + 1;
        nextAyahToPlayIndex = next < ayahs.length ? next : ayahs.length; // Ù„Ùˆ Ø¢Ø®Ø± Ø¢ÙŠØ© â†’ Ù…ÙƒØªÙ…Ù„
    } else {
        setStatus("Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¢ÙŠØ© Ø¨ÙˆØ¶ÙˆØ­. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "error");
    }
}

/* =========================
   Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ø­Ø§Ù„Ø©
   ========================= */

function setStatus(text, level = "normal") {
    statusMessage.textContent = text;
    statusMessage.className = "status";
    if (level === "strong") statusMessage.classList.add("status-strong");
    else if (level === "warn") statusMessage.classList.add("status-warn");
    else if (level === "info") statusMessage.classList.add("status-info");
    else if (level === "done") statusMessage.classList.add("status-done");
    else if (level === "error") statusMessage.classList.add("status-error");
}

function enableMainControls(enabled) {
    btnTasmi.disabled = !enabled;
    btnTilawa.disabled = !enabled;
    btnStop.disabled = false; // Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…ØªØ§Ø­
    surahSelect.disabled = !enabled;
    reciterSelect.disabled = !enabled;
    // Ø­Ù‚Ù„ Ø§Ù„Ø¢ÙŠØ© ÙŠØ­Ø¯Ø¯ Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¶Ø¹ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡Ù‡
}

/* =========================
   Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Events)
   ========================= */

delayRange.addEventListener("input", () => {
    delayValue.textContent = `Ù…Ø¯Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: ${delayRange.value} Ø«Ø§Ù†ÙŠØ©`;
});

surahSelect.addEventListener("change", async () => {
    const val = surahSelect.value;
    if (!val) {
        currentSurah = null;
        ayahs = [];
        updateProgress(0, 0);
        ayahLabel.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢ÙŠØ© Ù…Ø¹Ø±ÙˆØ¶Ø©";
        ayahTextBox.textContent = "";
        setStatus("Ø§Ø®ØªØ± Ø³ÙˆØ±Ø© Ù„Ù„Ø¨Ø¯Ø¡.", "normal");
        return;
    }
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    await loadSurah(val);
});

reciterSelect.addEventListener("change", async () => {
    currentAudioEdition = reciterSelect.value;
    // Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª: Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆØ§Ù‚ÙØ§Ù‹ â†’ ÙŠØ¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    // ÙˆÙ„Ùˆ ÙÙŠ ÙˆØ³Ø· Ø§Ù„ØªØ³Ù…ÙŠØ¹/Ø§Ù„ØªÙ„Ø§ÙˆØ© â†’ Ù„Ø§ ÙŠØªØ£Ø«Ø±
    if (mode === "idle" && currentSurah) {
        await loadSurah(currentSurah);
    } else {
        setStatus("Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø© Ø£Ùˆ Ø¨Ø¯Ø¡ ÙˆØ¶Ø¹ Ø¬Ø¯ÙŠØ¯.", "info");
    }
});

btnTilawa.addEventListener("click", () => {
    if (!surahSelect.value) {
        setStatus("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.", "error");
        return;
    }
    startTilawa();
});

btnTasmi.addEventListener("click", () => {
    if (!surahSelect.value) {
        setStatus("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹.", "error");
        return;
    }
    startTasmi();
});

btnStop.addEventListener("click", () => {
    mode = "idle";
    stopCurrentAudio();
    stopRecognition();
    cancelCountdown();
    enableMainControls(true);
    ayahInput.disabled = false;

    listeningDot.classList.remove("active");
    modeBadge.textContent = "ÙˆØ¶Ø¹ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„";
    modeBadge.className = "mode-badge";

    setStatus("ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø³ÙˆØ±Ø© Ø£Ùˆ ÙˆØ¶Ø¹ Ø¬Ø¯ÙŠØ¯.", "normal");
});

/* =========================
   Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
   ========================= */

document.addEventListener("DOMContentLoaded", () => {
    loadSurahList(); // ÙŠØ¬Ù„Ø¨ 114 Ø³ÙˆØ±Ø© Ù…Ù† API alquran.cloud [web:10][web:19][web:22]
});
</script>
</body>
</html>
