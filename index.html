<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ³Ù…ÙŠØ¹/ØªÙ„Ø§ÙˆØ© - ØªØ·Ø¨ÙŠÙ‚ Ù„Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† (ØªØ¬Ø±ÙŠØ¨ÙŠ)</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --text:#e6eef8;
      --green:#16a34a; --blue:#2563eb; --yellow:#f59e0b; --lightgreen:#34d399;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Naskh Arabic',"Helvetica Neue",Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071124 0%, #071a2a 100%);color:var(--text)}
    .wrap{max-width:900px;margin:14px auto;padding:14px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0}

    label{display:block;font-size:13px;margin:8px 0 6px}
    select,input[type=number],.range{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);font-size:15px}

    .controls{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .buttons{display:flex;gap:8px;margin-top:12px}
    button{flex:1;padding:12px;border-radius:10px;border:0;font-size:16px}
    .btn-record{background:linear-gradient(90deg,var(--blue),#60a5fa);color:white}
    .btn-read{background:linear-gradient(90deg,var(--green),#86efac);color:black}
    .btn-stop{background:linear-gradient(90deg,var(--yellow),#fcd34d);color:black}

    .status{margin-top:12px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:14px}

    .progress-wrap{margin-top:12px}
    .progress{height:12px;border-radius:12px;background:rgba(255,255,255,0.04);overflow:hidden}
    .progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--green),#34d399)}
    .message{margin-top:8px;font-weight:600}

    .ayah-box{margin-top:14px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);min-height:78px}
    .ayah-text{font-size:20px;line-height:1.6;direction:rtl;text-align:right}
    .w-green{color:var(--green)}
    .w-blue{color:var(--blue)}
    .w-yellow{color:var(--yellow)}
    .list-row{display:flex;gap:8px;align-items:center}

    /* responsive mobile */
    @media (max-width:520px){
      .controls{grid-template-columns:1fr}
      header{flex-direction:column;align-items:flex-start;gap:8px}
      .buttons{flex-direction:column}
      .ayah-text{font-size:18px}
    }

    footer{margin-top:14px;font-size:12px;color:rgba(230,238,248,0.6)}
  </style>
</head>
<body>
  <div class="wrap card">
    <header>
      <h1>ØªØ·Ø¨ÙŠÙ‚ ØªØ³Ù…ÙŠØ¹ / ØªÙ„Ø§ÙˆØ© (Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©)</h1>
      <div style="text-align:left;font-size:12px;opacity:.9">Ù…Ø­Ù…Ù‘Ù„ Ù…Ù†: cdn.islamic.network</div>
    </header>

    <div style="margin-top:10px">
      <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙˆØ±Ø©</label>
      <select id="suraSelect"></select>

      <div class="controls" style="margin-top:8px">
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="ayahNumber" type="number" min="1" placeholder="Ù…Ø«Ø§Ù„: 1" />
        </div>
        <div>
          <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø±Ø¦</label>
          <select id="reciterSelect"></select>
        </div>
      </div>

      <div style="margin-top:8px">
        <label>Ù…Ù†Ø²Ù„Ù‚ Ø§Ù„ØªØ£Ø®ÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø«ÙˆØ§Ù†Ù) <span id="delayVal">10</span>s</label>
        <input id="delayRange" class="range" type="range" min="5" max="20" value="10" />
      </div>

      <div class="buttons">
        <button id="btnRecord" class="btn-record">ğŸ¤ ØªØ³Ù…ÙŠØ¹</button>
        <button id="btnRead" class="btn-read">ğŸ“– ØªÙ„Ø§ÙˆØ©</button>
        <button id="btnStop" class="btn-stop">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
      </div>

      <div class="status" id="status">ğŸ¤ Ø§Ø³ØªÙ…Ø¹... Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© (Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ØªØ³Ù…ÙŠØ¹)</div>

      <div class="progress-wrap">
        <label>Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…</label>
        <div class="progress"><i id="progressBar"></i></div>
        <div class="message" id="progressText">0 / 0</div>
      </div>

      <div class="ayah-box" id="ayahBox">
        <div class="ayah-text" id="ayahText">Ù„Ù… ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯</div>
      </div>

      <footer>Ø§Ù„Ø£Ù„ÙˆØ§Ù†: <span style="color:var(--green)">Ø£Ø®Ø¶Ø±=ØªÙ„Ø§ÙˆØ©</span> â€¢ <span style="color:var(--blue)">Ø£Ø²Ø±Ù‚=ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ ØªØ³Ù…ÙŠØ¹</span> â€¢ <span style="color:var(--yellow)">Ø£ØµÙØ±=Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„/Ø§Ù†ØªØ¸Ø§Ø±</span></footer>
    </div>
  </div>

  <script>
  /* ------------------ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„) ------------------ */
  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ± (Ù†Øµ Ø¨Ø³ÙŠØ·: Ø±Ù‚Ù… - Ø§Ø³Ù…). ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø£Ø³Ù…Ø§Ø¡ Ø¹Ø±Ø¨ÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©.
  const suraNames = [
    "1 Ø§Ù„ÙØ§ØªØ­Ø©","2 Ø§Ù„Ø¨Ù‚Ø±Ø©","3 Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†","4 Ø§Ù„Ù†Ø³Ø§Ø¡","5 Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©","6 Ø§Ù„Ø£Ù†Ø¹Ø§Ù…","7 Ø§Ù„Ø£Ø¹Ø±Ø§Ù","8 Ø§Ù„Ø£Ù†ÙØ§Ù„","9 Ø§Ù„ØªÙˆØ¨Ø©","10 ÙŠÙˆÙ†Ø³",
    "11 Ù‡ÙˆØ¯","12 ÙŠÙˆØ³Ù","13 Ø§Ù„Ø±Ø¹Ø¯","14 Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…","15 Ø§Ù„Ø­Ø¬Ø±","16 Ø§Ù„Ù†Ø­Ù„","17 Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡","18 Ø§Ù„ÙƒÙ‡Ù","19 Ù…Ø±ÙŠÙ…","20 Ø·Ù‡",
    "21 Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡","22 Ø§Ù„Ø­Ø¬","23 Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†","24 Ø§Ù„Ù†ÙˆØ±","25 Ø§Ù„ÙØ±Ù‚Ø§Ù†","26 Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡","27 Ø§Ù„Ù†Ù…Ù„","28 Ø§Ù„Ù‚ØµØµ","29 Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª","30 Ø§Ù„Ø±ÙˆÙ…",
    "31 Ù„Ù‚Ù…Ø§Ù†","32 Ø§Ù„Ø³Ø¬Ø¯Ø©","33 Ø§Ù„Ø£Ø­Ø²Ø§Ø¨","34 Ø³Ø¨Ø¥","35 ÙØ§Ø·Ø±","36 ÙŠØ³","37 Ø§Ù„ØµØ§ÙØ§Øª","38 Øµ","39 Ø§Ù„Ø²Ù…Ø±","40 ØºØ§ÙØ±",
    "41 ÙØµÙ„Øª","42 Ø§Ù„Ø´ÙˆØ±Ù‰","43 Ø§Ù„Ø²Ø®Ø±Ù","44 Ø§Ù„Ø¯Ø®Ø§Ù†","45 Ø§Ù„Ø¬Ø§Ø«ÙŠØ©","46 Ø§Ù„Ø£Ø­Ù‚Ø§Ù","47 Ù…Ø­Ù…Ø¯","48 Ø§Ù„ÙØªØ­","49 Ø§Ù„Ø­Ø¬Ø±Ø§Øª","50 Ù‚",
    "51 Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª","52 Ø§Ù„Ø·ÙˆØ±","53 Ø§Ù„Ù†Ø¬Ù…","54 Ø§Ù„Ù‚Ù…Ø±","55 Ø§Ù„Ø±Ø­Ù…Ù†","56 Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©","57 Ø§Ù„Ø­Ø¯ÙŠØ¯","58 Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©","59 Ø§Ù„Ø­Ø´Ø±","60 Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©",
    "61 Ø§Ù„ØµÙ","62 Ø§Ù„Ø¬Ù…Ø¹Ø©","63 Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†","64 Ø§Ù„ØªØºØ§Ø¨Ù†","65 Ø§Ù„Ø·Ù„Ø§Ù‚","66 Ø§Ù„ØªØ­Ø±ÙŠÙ…","67 Ø§Ù„Ù…Ù„Ùƒ","68 Ø§Ù„Ù‚Ù„Ù…","69 Ø§Ù„Ø­Ø§Ù‚Ø©","70 Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬",
    "71 Ù†ÙˆØ­","72 Ø§Ù„Ø¬Ù†","73 Ø§Ù„Ù…Ø²Ù…Ù„","74 Ø§Ù„Ù…Ø¯Ø«Ø±","75 Ø§Ù„Ù‚ÙŠØ§Ù…Ø©","76 Ø§Ù„Ø¥Ù†Ø³Ø§Ù†","77 Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª","78 Ø§Ù„Ù†Ø¨Ø£","79 Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª","80 Ø¹Ø¨Ø³",
    "81 Ø§Ù„ØªÙƒÙˆÙŠØ±","82 Ø§Ù„Ø¥Ù†ÙØ·Ø§Ø±","83 Ø§Ù„Ù…Ø·ÙÙÙŠÙ†","84 Ø§Ù„Ø¥Ù†Ø´Ù‚Ø§Ù‚","85 Ø§Ù„Ø¨Ø±ÙˆØ¬","86 Ø§Ù„Ø·Ø§Ø±Ù‚","87 Ø§Ù„Ø£Ø¹Ù„Ù‰","88 Ø§Ù„ØºØ§Ø´ÙŠØ©","89 Ø§Ù„ÙØ¬Ø±","90 Ø§Ù„Ø¨Ù„Ø¯",
    "91 Ø§Ù„Ø´Ù…Ø³","92 Ø§Ù„Ù„ÙŠÙ„","93 Ø§Ù„Ø¶Ø­Ù‰","94 Ø§Ù„Ø´Ø±Ø­","95 Ø§Ù„ØªÙŠÙ†","96 Ø§Ù„Ø¹Ù„Ù‚","97 Ø§Ù„Ù‚Ø¯Ø±","98 Ø§Ù„Ø¨ÙŠÙ†Ø©","99 Ø§Ù„Ø²Ù„Ø²Ù„Ø©","100 Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª",
    "101 Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©","102 Ø§Ù„ØªÙƒØ§Ø«Ø±","103 Ø§Ù„Ø¹ØµØ±","104 Ø§Ù„Ù‡Ù…Ø²Ø©","105 Ø§Ù„ÙÙŠÙ„","106 Ù‚Ø±ÙŠØ´","107 Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†","108 Ø§Ù„ÙƒÙˆØ«Ø±","109 Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†","110 Ø§Ù„Ù†ØµØ±",
    "111 Ø§Ù„Ù…Ø³Ø¯","112 Ø§Ù„Ø¥Ø®Ù„Ø§Øµ","113 Ø§Ù„ÙÙ„Ù‚","114 Ø§Ù„Ù†Ø§Ø³"
  ];

  // Ø¹Ø¯Ø¯ Ø§Ù„Ø¢ÙŠØ§Øª Ù„ÙƒÙ„ Ø³ÙˆØ±Ø© (Ø§Ù„Ù‚ÙŠÙ…Ø© Ù‡Ù†Ø§ Ù…Ø¬Ø±Ø¯ Ù…Ø«Ø§Ù„: Ù„Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙŠÙÙØ¶Ù‘Ù„ ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ù† Ù…ØµØ¯Ø± Ù…ÙˆØ«ÙˆÙ‚).
  // Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„ØŒ Ø£Ø¶Ù Ù…ØµÙÙˆÙØ© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø¢ÙŠØ§Øª Ù„ÙƒÙ„ Ø³ÙˆØ±Ø© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
  const ayahCounts = [7,286,200,176,120,165,206,75,129,109,123,111,43,52,99,128,111,110,98,135,112,78,118,64,77,227,93,88,69,60,34,30,73,54,45,83,182,88,75,85,54,53,89,59,37,35,38,29,18,45,60,49,62,55,78,96,29,22,24,13,14,11,11,18,12,12,30,52,52,44,28,28,20,56,40,31,50,40,46,42,29,19,36,25,22,17,19,26,30,20,15,21,11,8,8,3,9,5,4,7,3,6,3,5,4,5,6,3,5,4,6,3,5,6];
  // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ù† Ø£Ø±Ø¯Øª Ø§Ù„Ù…ØµØ¯Ø§Ù‚ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø©ØŒ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ ayahCounts Ùˆ ayahTexts Ù…Ù† Ù…ØµØ¯Ø± Ù…ÙˆØ«ÙˆÙ‚ (Quran API Ø£Ùˆ Ù…Ù„Ù JSON Ù…Ø­Ù„ÙŠ) â€” ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¯Ù†Ø§Ù‡.

  // Ù‚Ø§Ø¦Ù…Ø© Ù‚Ø§Ø±Ø¦ÙŠÙ† (Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø¹Ù†Ø¯ cdn.islamic.network). Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø¨Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ø¯ÙŠÙƒ.
  const reciters = [
    {id:'alafasy',label:'Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ'},
    {id:'minshawi',label:'Ø§Ù„Ø´ÙŠØ® Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ'},
    {id:'abdulbasit',label:'Ø¹Ø¨Ø¯ Ø§Ù„Ø¨Ø§Ø³Ø·'},
    {id:'alqasim',label:'Ø§Ù„Ù‚Ø§Ø³Ù…'},
    {id:'alhussary',label:'Ø§Ù„Ø­ØµØ±ÙŠ'},
    {id:'alattar',label:'Ø§Ù„Ø¹Ø·Ø§Ø±'},
    {id:'hisham',label:'Ù‡Ø´Ø§Ù…'},
    {id:'sudais',label:'Ø§Ù„Ø³Ø¯ÙŠØ³'},
    {id:'hafs',label:'Ø­ÙØµ'},
    {id:'imam',label:'Ø§Ù„Ù‚Ø§Ø±Ø¦ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ'}
  ];

  /* ------------------ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ------------------ */
  const suraSel = document.getElementById('suraSelect');
  const reciterSel = document.getElementById('reciterSelect');
  const ayahInput = document.getElementById('ayahNumber');
  const delayRange = document.getElementById('delayRange');
  const delayVal = document.getElementById('delayVal');
  const btnRecord = document.getElementById('btnRecord');
  const btnRead = document.getElementById('btnRead');
  const btnStop = document.getElementById('btnStop');
  const status = document.getElementById('status');
  const ayahTextEl = document.getElementById('ayahText');
  const progressBar = document.getElementById('progressBar');
  const progressText = document.getElementById('progressText');

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
  suraNames.forEach((n,i)=>{
    const opt = document.createElement('option'); opt.value = i+1; opt.textContent = (i+1)+" - "+n; suraSel.appendChild(opt);
  });
  reciters.forEach(r=>{const o=document.createElement('option');o.value=r.id;o.textContent=r.label;reciterSel.appendChild(o);});

  delayRange.addEventListener('input', ()=>{delayVal.textContent = delayRange.value});

  /* ------------------ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª ------------------ */
  let mode = null; // 'tasmi' | 'talaa' | null
  let recognition = null;
  let audio = new Audio();
  let isPlaying = false;
  let currentSura = 1;
  let currentAyah = 1;
  let totalAyahs = ayahCounts[0] || 0;
  let nextAyahToPlay = null;
  let timeoutHandle = null;

  // Ù…Ø®Ø²Ù† Ù†ØµÙˆØµ Ø§Ù„Ø¢ÙŠØ§Øª (Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¹Ù…Ù„ Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ). Ù‡Ù†Ø§ Ù†Ø¶Ø¹ Ù…Ø«Ø§Ù„ Ù„Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø© ÙÙ‚Ø·.
  // ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ayahTexts[suraNumber] Ø¨Ù…ØµÙÙˆÙØ© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Øµ ÙƒÙ„ Ø¢ÙŠØ© (Ø¨Ø¯ÙˆÙ† ØªØ´ÙƒÙŠÙ„) Ù„Ù„Ù‚ÙŠØ§Ù… Ø¨Ù…Ù‚Ø§Ø±Ù†Ø© Ø¯Ù‚ÙŠÙ‚Ø©.
  const ayahTexts = {
    1: [
      'Ø§Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù°Ù‡Ù Ø±ÙØ¨ÙÙ‘ Ø§Ù„Ù’Ø¹ÙØ§Ù„ÙÙ…ÙÙŠÙ†Ù',
      'Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù',
      'Ù…ÙØ§Ù„ÙÙƒÙ ÙŠÙÙˆÙ’Ù…Ù Ø§Ù„Ø¯ÙÙ‘ÙŠÙ†Ù',
      'Ø¥ÙÙŠÙÙ‘Ø§ÙƒÙ Ù†ÙØ¹Ù’Ø¨ÙØ¯Ù ÙˆÙØ¥ÙÙŠÙÙ‘Ø§ÙƒÙ Ù†ÙØ³Ù’ØªÙØ¹ÙÙŠÙ†Ù',
      'Ø§Ù‡Ù’Ø¯ÙÙ†ÙØ§ Ø§Ù„ØµÙÙ‘Ø±ÙØ§Ø·Ù Ø§Ù„Ù’Ù…ÙØ³Ù’ØªÙÙ‚ÙÙŠÙ…Ù',
      'ØµÙØ±ÙØ§Ø·Ù Ø§Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù Ø£ÙÙ†Ù’Ø¹ÙÙ…Ù’ØªÙ Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’',
      'ØºÙÙŠÙ’Ø±Ù Ø§Ù„Ù’Ù…ÙØºÙ’Ø¶ÙÙˆØ¨Ù Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’ ÙˆÙÙ„ÙØ§ Ø§Ù„Ø¶ÙÙ‘Ø§Ù„ÙÙ‘ÙŠÙ†Ù'
    ]
  };

  /* ------------------ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ------------------ */
  function normalizeArabic(str){
    if(!str) return '';
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„ ÙˆØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠÙ… ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù…
    return str.replace(/[\u0610-\u061A\u064B-\u065F\u06D6-\u06ED]/g,'')
              .replace(/[ÙÙ‹ÙÙŒÙÙÙ’Ù‘ÂªÂºâ€¢ØŒ.?!"'()\-â€“]/g,'')
              .replace(/[0-9Ù -Ù©]/g,'')
              .replace(/\s+/g,' ').trim().toLowerCase();
  }

  function updateProgress(cur, total){
    const pct = total? Math.round((cur/total)*100) : 0;
    progressBar.style.width = pct + '%';
    progressText.textContent = `${cur} / ${total} â€” ${pct}%`;
  }

  function setStatus(msg, colorClass){
    status.textContent = msg;
    // Ø¨Ø³ÙŠØ·: Ø³Ù†ØºÙŠÙ‘Ø± Ø§Ù„Ø®Ù„ÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    if(colorClass==='green') status.style.borderLeft = '4px solid var(--green)';
    else if(colorClass==='blue') status.style.borderLeft = '4px solid var(--blue)';
    else if(colorClass==='yellow') status.style.borderLeft = '4px solid var(--yellow)';
    else status.style.borderLeft = 'none';
  }

  function playAyahAudio(sura, ayah){
    const reciter = reciterSel.value || reciters[0].id;
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‚Ø¯ ÙŠØ®ØªÙ„Ù Ù…Ø³Ø§Ø± Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª Ø¹Ù„Ù‰ cdn. Ù‡Ø°Ø§ Ù‚Ø§Ù„Ø¨ Ø´Ø§Ø¦Ø¹:
    const url = `https://cdn.islamic.network/quran/audio/128/${reciter}/${sura}/${ayah}.mp3`;
    audio.src = url;
    audio.play().catch(e=>console.warn('play failed',e));
    isPlaying = true;
    setStatus('ğŸ“» ØªØ´ØºÙŠÙ„ Ø¢ÙŠØ© '+ayah,'yellow');
    highlightAyahDuringPlayback('blue');
    audio.onended = ()=>{ isPlaying=false; highlightAyahDuringPlayback(); if(mode==='talaa'){ onAyahFinishedSequential(); } };
  }

  function highlightAyahDuringPlayback(color){
    if(color==='green'){ ayahTextEl.classList.add('w-green'); ayahTextEl.classList.remove('w-blue'); }
    else if(color==='blue'){ ayahTextEl.classList.add('w-blue'); ayahTextEl.classList.remove('w-green'); }
    else { ayahTextEl.classList.remove('w-blue'); ayahTextEl.classList.remove('w-green'); }
  }

  function loadSuraMeta(){
    currentSura = parseInt(suraSel.value);
    totalAyahs = ayahCounts[currentSura-1] || 0;
    updateProgress(0,totalAyahs);
  }

  suraSel.addEventListener('change', ()=>{
    loadSuraMeta();
    ayahInput.value='';
    setStatus('Ø¬Ø§Ù‡Ø²');
    // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ù†ØµÙˆØµ Ø§Ù„Ø¢ÙŠØ§Øª Ù…Ù† Ù…Ù„Ù JSON Ø£Ùˆ API Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø³ÙˆØ±Ø©
    // Ù…Ø«Ø§Ù„: fetch(`/quran_texts/sura_${currentSura}.json`).then(r=>r.json()).then(arr=>{ayahTexts[currentSura]=arr;});
  });

  /* ------------------ ÙˆØ¶Ø¹ Ø§Ù„ØªÙ„Ø§ÙˆØ© (ØªØ´ØºÙŠÙ„ ØªØ³Ù„Ø³Ù„ÙŠ) ------------------ */
  btnRead.addEventListener('click', ()=>{
    mode='talaa';
    stopAll();
    loadSuraMeta();
    let start = parseInt(ayahInput.value) || 1;
    if(start<1) start=1; if(start>totalAyahs) start=totalAyahs;
    currentAyah = start;
    // Ø¨Ø³Ù…Ù„Ø©
    if(start===1 && currentSura!==9){ ayahTextEl.textContent='Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…'; highlightAyahDuringPlayback('green'); playSimpleAudioString('Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…'); setTimeout(()=>{ playAyahAudio(currentSura,currentAyah); }, 1200); }
    else { playAyahAudio(currentSura,currentAyah); highlightAyahDuringPlayback('green'); }
  });

  function playSimpleAudioString(text){
    // ÙˆØ¸ÙŠÙØ© Ù…Ø¤Ù‚ØªØ©: Ù„Ø§ ØªØ´ØºÙ‘Ù„ ØµÙˆØª ÙØ¹Ù„ÙŠ. ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø´ØºÙ‘Ù„ Ù…Ù„Ù ØµÙˆØªÙŠ Ù„Ø¨Ø³Ù…Ù„Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… TTS.
    console.log('Ø¨Ø³Ù…Ù„Ø© (Ù†Øµ):',text);
  }

  function onAyahFinishedSequential(){
    updateProgress(currentAyah, totalAyahs);
    // Ø¹Ø±Ø¶ Ø§Ù„Ø¢ÙŠØ© Ø¨Ø§Ù„Ù†Øµ Ø¥Ù† ÙˆÙØ¬Ø¯
    displayAyahText(currentSura, currentAyah);
    // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
    setTimeout(()=>{
      currentAyah++;
      if(currentAyah>totalAyahs){ setStatus('ğŸ‰ Ø¥ÙƒÙ…Ø§Ù„!'); stopAll(); }
      else { playAyahAudio(currentSura,currentAyah); }
    }, 1200);
  }

  function displayAyahText(sura,ayah){
    const arr = ayahTexts[sura];
    if(arr && arr[ayah-1]){ ayahTextEl.innerHTML = arr[ayah-1]; }
    else { ayahTextEl.innerHTML = `Ø³ÙˆØ±Ø© ${sura} - Ø¢ÙŠØ© ${ayah}`; }
  }

  /* ------------------ ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ù…ÙŠØ¹ (Ø§Ø³ØªÙ…Ø§Ø¹ + ÙƒØ´Ù) ------------------ */
  btnRecord.addEventListener('click', ()=>{
    mode='tasmi';
    stopAll();
    loadSuraMeta();
    setStatus('ğŸ¤ Ø§Ø³ØªÙ…Ø¹... Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©');
    prepareSpeechRecognition();
  });

  function prepareSpeechRecognition(){
    // ØªØ£Ù…ÙŠÙ† ØªÙˆØ§ÙÙ‚ Ø§Ù„ API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SpeechRecognition){ alert('Ø§Ù„ØªØ¹Ø±Ù‘Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù…ØªØµÙØ­Ùƒ. Ø§Ø³ØªØ®Ø¯Ù… Chrome/Edge Ø¹Ù„Ù‰ Android.'); return; }

    recognition = new SpeechRecognition();
    recognition.lang = 'ar-SA';
    recognition.continuous = true;
    recognition.interimResults = true;

    let lastResultAt = Date.now();
    let partial = '';

    recognition.onresult = (ev)=>{
      let finalTranscript = '';
      for(let i=ev.resultIndex;i<ev.results.length;i++){
        const res = ev.results[i];
        if(res.isFinal) finalTranscript += res[0].transcript + ' ';
        else partial = res[0].transcript;
      }
      if(finalTranscript.trim()){
        lastResultAt = Date.now();
        // Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
        handleRecognized(finalTranscript.trim());
      }
    };

    recognition.onend = ()=>{
      // Ø£Ø¹Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¥Ø°Ø§ Ù…Ø§ Ø²Ø§Ù„ Ø§Ù„ÙˆØ¶Ø¹ Ù†Ø´Ø·
      if(mode==='tasmi'){ recognition.start(); }
    };

    recognition.onerror = (e)=>{ console.warn('recognition error', e); setStatus('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù'); }

    recognition.start();

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØµÙ…Øª: Ù„Ùˆ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù†ØªÙŠØ¬Ø© Ù„Ù…Ø¯Ø© Ø«Ø§Ù†ÙŠØªÙŠÙ†ØŒ Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
    setInterval(()=>{
      if(mode!=='tasmi' || !recognition) return;
      const now = Date.now();
      // Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… lastResultAt Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ØŒ Ù„ÙƒÙ† Ù†Ø­ØªÙØ¸ Ø¨Ù‡ ÙÙŠ Ø§Ù„ closure Ø¨Ø§Ù„Ø£Ø³ÙÙ„.
    },1000);
  }

  function handleRecognized(text){
    setStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...');
    const norm = normalizeArabic(text);
    console.log('recognized:', norm);

    // Ø¥Ù† ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙ†Ø§ Ù†ØµÙˆØµ Ø§Ù„Ø¢ÙŠØ§Øª Ù„Ù„Ø³ÙˆØ±Ø©: Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø¨Ø³Ø·Ø© (Ù†Ø³Ø¨Ø© ØªØ·Ø§Ø¨Ù‚ ØªÙ‚Ø±ÙŠØ¨ÙŠØ©)
    const sura = currentSura;
    const arr = ayahTexts[sura];
    if(arr && arr.length){
      // Ù†Ø­Ø³Ø¨ Ø£Ø¨Ø³Ø· ØªÙ‚Ø§Ø±Ø¨: Ù‡Ù„ ÙŠØªØ¶Ù…Ù† Ø§Ù„Ù†Øµ Ø¬Ø²Ø¡Ù‹Ø§ Ù…Ù† Ø¢ÙŠØ©ØŸ
      let bestIdx = -1, bestScore=0;
      const normWords = norm.split(' ');
      arr.forEach((aya,idx)=>{
        const naya = normalizeArabic(aya);
        let score=0;
        normWords.forEach(w=>{ if(naya.includes(w) && w.length>2) score += w.length; });
        if(score>bestScore){ bestScore=score; bestIdx=idx; }
      });
      // Ù…Ø¹ÙŠØ§Ø± Ø¨Ø³ÙŠØ·: Ø¥Ù† ÙƒØ§Ù†Øª Ø§Ù„Ù†Ù‚Ø·Ø© Ø£Ø¹Ù„Ù‰ Ù…Ù† thresh
      if(bestScore>6){
        const detected = bestIdx+1;
        setStatus('âœ… Ø¢ÙŠØ© Ø±Ù‚Ù… '+detected,'green');
        displayAyahText(sura,detected);
        updateProgress(detected, totalAyahs);
        nextAyahToPlay = detected+1;
        // Ø¨Ø¹Ø¯ ÙƒØ´Ù Ø§Ù„Ø¢ÙŠØ©ØŒ Ù†Ù†ØªØ¸Ø± ØµÙ…Øª Ø«Ù… Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ù„ØªØ´ØºÙŠÙ„
        startCountdownThenPlay();
        return;
      }
    }

    // Ø¥Ù† Ù„Ù… ØªØªÙˆÙØ± Ù†ØµÙˆØµ Ø§Ù„Ø¢ÙŠØ§Øª: Ù…Ø­Ø§ÙƒØ§Ø© Ø°ÙƒÙŠØ©: Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£Ø±Ù‚Ø§Ù… Ù…Ù†Ø·ÙˆÙ‚Ø© Ø£Ùˆ Ù†Ø¹Ø·ÙŠ ÙƒØ´Ù ØªÙ‚Ø±ÙŠØ¨ÙŠ
    const foundNum = text.match(/\b(\d{1,3}|[Ù -Ù©]{1,3})\b/);
    if(foundNum){
      const num = parseInt(foundNum[0].replace(/[Ù -Ù©]/g,m=>"0123456789"["Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(m)]));
      setStatus('âœ… Ø¢ÙŠØ© Ø±Ù‚Ù… '+num,'green'); displayAyahText(sura,num); updateProgress(num,totalAyahs); nextAyahToPlay = num+1; startCountdownThenPlay(); return;
    }

    // Ù„Ùˆ Ù„Ù… Ù†ÙƒØ´Ù: Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙˆÙ†ØªØ§Ø¨Ø¹ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹
    setStatus('Ù„Ù… ÙŠØªÙ… Ø§Ù„ÙƒØ´Ù - Ø­Ø§ÙˆÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙˆØ¶ÙˆØ­');
  }

  function startCountdownThenPlay(){
    const delay = parseInt(delayRange.value) || 10;
    clearTimeout(timeoutHandle);
    setStatus('â±ï¸ '+delay+'Ø« - Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„','yellow');
    timeoutHandle = setTimeout(()=>{
      // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¥Ù† ÙˆÙØ¬Ø¯Øª
      if(nextAyahToPlay && nextAyahToPlay<=totalAyahs){
        playAyahAudio(currentSura,nextAyahToPlay);
        displayAyahText(currentSura,nextAyahToPlay);
        updateProgress(nextAyahToPlay,totalAyahs);
        // Ø¨Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢ÙŠØ© Ù†Ø¹ÙˆØ¯ Ù„Ù„Ø§Ø³ØªÙ…Ø§Ø¹
        audio.onended = ()=>{ setTimeout(()=>{ if(mode==='tasmi') setStatus('ğŸ¤ Ø§Ø³ØªÙ…Ø¹... Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©'); },300); };
      } else { setStatus('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¢ÙŠØ© ØªØ§Ù„ÙŠØ©'); }
    }, delay*1000);
  }

  /* ------------------ ÙˆØ¸Ø§Ø¦Ù Ø¹Ø§Ù…Ø© Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù ÙˆØ§Ù„ØªÙ†Ø¸ÙŠÙ ------------------ */
  btnStop.addEventListener('click', ()=>{ stopAll(); setStatus('ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù'); });

  function stopAll(){
    mode=null;
    if(recognition){ try{ recognition.stop(); }catch(e){} recognition=null; }
    if(audio){ try{ audio.pause(); audio.currentTime=0; }catch(e){} }
    isPlaying=false; clearTimeout(timeoutHandle);
    highlightAyahDuringPlayback();
  }

  // Ø¹Ù†Ø¯ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø±Ø¦ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆÙ‚Ù Ù†Ø¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø±Ø¦ (Ù„Ø§ Ù†Ø¤Ø«Ø± Ù„Ùˆ ÙƒØ§Ù† Ø¬Ø§Ø±ÙŠØ§Ù‹)
  reciterSel.addEventListener('change', ()=>{ if(!isPlaying) setStatus('Ø¬Ø§Ù‡Ø² â€” ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø§Ø±Ø¦'); });

  // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©
  (function init(){ suraSel.value=1; reciterSel.value=reciters[0].id; loadSuraMeta(); setStatus('Ø¬Ø§Ù‡Ø²'); displayAyahText(1,1); })();

  </script>
</body>
</html>
