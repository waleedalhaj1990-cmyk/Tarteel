<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­ÙØ¸</title>
  <style>
    * {margin: 0; padding: 0; box-sizing: border-box;}
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      padding: 5px;
      direction: rtl;
      overflow: hidden;
    }
    .container {
      max-width: 100%;
      height: calc(100vh - 10px);
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      padding: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 5px;
      font-size: 1.1em;
      line-height: 1.2;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 5px;
    }
    .row {
      display: flex;
      gap: 5px;
    }
    .row select,
    .row input {
      flex: 1;
    }
    select, input, button {
      padding: 7px 8px;
      font-size: 12px;
      border: 1.5px solid #667eea;
      border-radius: 5px;
      background: white;
      width: 100%;
    }
    .delay-control {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 8px;
      border: 1.5px solid #667eea;
      border-radius: 5px;
      background: white;
    }
    .delay-control label {
      font-weight: bold;
      color: #667eea;
      font-size: 11px;
      white-space: nowrap;
    }
    .delay-control input[type="range"] {
      flex: 1;
      padding: 0;
      border: none;
      height: 20px;
    }
    .delay-control span {
      font-weight: bold;
      color: #667eea;
      min-width: 35px;
      font-size: 11px;
    }
    .button-row {
      display: flex;
      gap: 4px;
    }
    .button-row button {
      flex: 1;
    }
    button {
      background: #667eea;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      padding: 9px 6px;
      font-size: 11px;
    }
    button:active {
      transform: scale(0.98);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button.recite-btn {
      background: #28a745;
    }
    button.stop-btn {
      background: #dc3545;
    }
    .status {
      padding: 6px;
      background: #f0f4ff;
      border-radius: 5px;
      margin-bottom: 5px;
      text-align: center;
      font-weight: bold;
      color: #667eea;
      font-size: 11px;
    }
    .status.listening {
      background: #d4edda;
      color: #155724;
      animation: pulse 1.5s infinite;
    }
    .status.reciting {
      background: #fff3cd;
      color: #856404;
    }
    @keyframes pulse {
      0%, 100% {opacity: 1;}
      50% {opacity: 0.7;}
    }
    .basmala {
      text-align: center;
      font-size: 20px;
      color: #667eea;
      font-weight: bold;
      margin-bottom: 5px;
      padding: 8px;
      background: #f0f4ff;
      border-radius: 5px;
      font-family: 'Traditional Arabic', 'Amiri', 'Arial', sans-serif;
      line-height: 1.5;
    }
    .basmala span {
      display: inline;
      padding: 2px 3px;
      border-radius: 3px;
      transition: all 0.3s;
    }
    .basmala span.highlight {
      background-color: #28a745;
      color: white;
      box-shadow: 0 2px 6px rgba(40, 167, 69, 0.4);
    }
    .current-ayah {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 5px;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      scroll-behavior: smooth;
      position: relative;
    }
    .ayah-text {
      font-size: 18px;
      line-height: 2;
      text-align: justify;
      color: #333;
      font-family: 'Traditional Arabic', 'Amiri', 'Arial', sans-serif;
      margin-bottom: 8px;
      word-wrap: break-word;
      flex: 1;
    }
    .ayah-text span {
      display: inline;
      padding: 2px 3px;
      border-radius: 3px;
      transition: background-color 0.05s ease-in-out;
    }
    .ayah-text span.highlight {
      background-color: #28a745;
      color: white;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(40, 167, 69, 0.4);
    }
    .ayah-text span.highlight-blue {
      background-color: #007bff;
      color: white;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0, 123, 255, 0.4);
    }
    .ayah-info {
      text-align: center;
      color: #666;
      font-size: 12px;
      font-weight: bold;
      margin-top: auto;
    }
    .timer {
      text-align: center;
      font-size: 18px;
      color: #dc3545;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .progress {
      background: #e9ecef;
      height: 18px;
      border-radius: 9px;
      margin-bottom: 5px;
      overflow: hidden;
    }
    .progress-bar {
      background: linear-gradient(90deg, #667eea, #764ba2);
      height: 100%;
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 10px;
    }
    .info-box {
      background: #fff3cd;
      padding: 6px 10px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #856404;
      font-size: 12px;
      font-weight: bold;
    }
    .designer {
      text-align: center;
      padding: 6px;
      color: #667eea;
      font-size: 11px;
      font-weight: bold;
    }
    
    @media (max-width: 400px) {
      .ayah-text {
        font-size: 16px;
      }
      .basmala {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ•Œ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­ÙØ¸</h1>
    
    <div class="controls">
      <div class="row">
        <select id="surahSelect">
          <option value="">Ø§Ù„Ø³ÙˆØ±Ø©</option>
        </select>
        
        <input type="number" id="startAyah" placeholder="Ø¢ÙŠØ© # (Ù„Ù„ØªÙ„Ø§ÙˆØ© ÙÙ‚Ø·)" min="1">
      </div>
      
      <select id="reciterSelect">
        <option value="ar.alafasy">Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ</option>
        <option value="ar.abdulbasitmurattal">Ø¹Ø¨Ø¯ Ø§Ù„Ø¨Ø§Ø³Ø·</option>
        <option value="ar.abdurrahmaansudais">Ø§Ù„Ø³Ø¯ÙŠØ³</option>
        <option value="ar.shaatree">Ø§Ù„Ø´Ø§Ø·Ø±ÙŠ</option>
        <option value="ar.minshawi">Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ</option>
        <option value="ar.husary">Ø§Ù„Ø­ØµØ±ÙŠ</option>
        <option value="ar.muhammadayyoub">Ù…Ø­Ù…Ø¯ Ø£ÙŠÙˆØ¨</option>
        <option value="ar.mahermuaiqly">Ù…Ø§Ù‡Ø± Ø§Ù„Ù…Ø¹ÙŠÙ‚Ù„ÙŠ</option>
        <option value="ar.saoodshuraym">Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø´Ø±ÙŠÙ…</option>
        <option value="ar.hudhaify">Ø¹Ù„ÙŠ Ø§Ù„Ø­Ø°ÙŠÙÙŠ</option>
      </select>
      
      <div class="delay-control">
        <label>Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±:</label>
        <input type="range" id="delaySlider" min="5" max="20" value="10" step="1">
        <span id="delayValue">10Ø«</span>
      </div>
      
      <div class="button-row">
        <button id="listenBtn" onclick="startListeningMode()">ğŸ¤ ØªØ³Ù…ÙŠØ¹</button>
        <button class="recite-btn" id="reciteBtn" onclick="startRecitationMode()">ğŸ“– ØªÙ„Ø§ÙˆØ©</button>
        <button class="stop-btn" id="stopBtn" onclick="stopAll()" disabled>â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
      </div>
    </div>
    
    <div class="progress">
      <div class="progress-bar" id="progressBar" style="width: 0%;">0%</div>
    </div>
    
    <div class="status" id="status">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø©</div>
    
    <div class="timer" id="timer" style="display: none;">
      â±ï¸ <span id="timerCount">10</span> Ø«
    </div>
    
    <div class="info-box">
      <span>ğŸ“– Ø¢ÙŠØ§Øª</span>
      <span id="ayahCount">-</span>
    </div>
    
    <div class="basmala" id="basmala" style="display: none;"></div>
    
    <div class="current-ayah" id="ayahContainer">
      <div class="ayah-text" id="ayahText">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ù„Ù„Ø¨Ø¯Ø¡</div>
      <div class="ayah-info" id="ayahInfo"></div>
    </div>
    
    <div class="designer">ØªØµÙ…ÙŠÙ… Ø¹Ù„ÙŠ Ø§Ù„ØµØ±Ø§ÙŠØ±Ø©</div>
  </div>

  <script>
    let recognition = null;
    let silenceTimer = null;
    let silenceTimeout = null;
    let silenceCount = 10;
    let delaySeconds = 10;
    let isListening = false;
    let isRecitingFull = false;
    let isPlayingInListenMode = false;
    
    let currentSurahData = null;
    let currentAyahIndex = 0;
    let allSurahs = [];
    let audioPlayer = new Audio();
    let animationFrameId = null;
    let needBasmala = false;
    let isPlayingBasmala = false;
    let selectedReciter = 'ar.alafasy';
    let lastDetectedAyahIndex = -1;
    let nextAyahToPlay = 0;
    
    const BASMALA_TEXT = "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù";
    
    const surahSelect = document.getElementById('surahSelect');
    const reciterSelect = document.getElementById('reciterSelect');
    const startAyahInput = document.getElementById('startAyah');
    const delaySlider = document.getElementById('delaySlider');
    const delayValue = document.getElementById('delayValue');
    const listenBtn = document.getElementById('listenBtn');
    const reciteBtn = document.getElementById('reciteBtn');
    const stopBtn = document.getElementById('stopBtn');
    const status = document.getElementById('status');
    const ayahText = document.getElementById('ayahText');
    const ayahInfo = document.getElementById('ayahInfo');
    const timerDisplay = document.getElementById('timer');
    const timerCount = document.getElementById('timerCount');
    const progressBar = document.getElementById('progressBar');
    const basmalaDiv = document.getElementById('basmala');
    const ayahContainer = document.getElementById('ayahContainer');
    const ayahCount = document.getElementById('ayahCount');
    
    delaySlider.addEventListener('input', function() {
      delaySeconds = parseInt(this.value);
      delayValue.textContent = delaySeconds + 'Ø«';
    });
    
    reciterSelect.addEventListener('change', function() {
      selectedReciter = this.value;
      if (currentSurahData) {
        reloadSurahAudio();
      }
    });
    
    async function loadSurahs() {
      try {
        const response = await fetch('https://api.alquran.cloud/v1/surah');
        const data = await response.json();
        allSurahs = data.data;
        
        surahSelect.innerHTML = '<option value="">Ø§Ù„Ø³ÙˆØ±Ø©</option>';
        allSurahs.forEach(surah => {
          const option = document.createElement('option');
          option.value = surah.number;
          option.textContent = `${surah.number}. ${surah.name}`;
          surahSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±:', error);
        status.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
      }
    }
    
    surahSelect.addEventListener('change', async function() {
      const surahNumber = this.value;
      if (!surahNumber) return;
      await loadSurahData(surahNumber);
    });
    
    async function loadSurahData(surahNumber) {
      try {
        status.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
        
        const textResponse = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}`);
        const textData = await textResponse.json();
        
        const audioResponse = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/${selectedReciter}`);
        const audioData = await audioResponse.json();
        
        currentSurahData = {
          number: surahNumber,
          name: textData.data.name,
          ayahs: textData.data.ayahs.map((ayah, index) => ({
            number: ayah.numberInSurah,
            text: ayah.text,
            audio: audioData.data.ayahs[index].audio
          }))
        };
        
        startAyahInput.max = currentSurahData.ayahs.length;
        
        ayahCount.textContent = currentSurahData.ayahs.length;
        
        currentAyahIndex = 0;
        lastDetectedAyahIndex = -1;
        nextAyahToPlay = 0;
        displayCurrentAyah(false);
        status.textContent = 'Ø¬Ø§Ù‡Ø²';
        
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø©:', error);
        status.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
      }
    }
    
    async function reloadSurahAudio() {
      if (!currentSurahData) return;
      const surahNumber = currentSurahData.number;
      await loadSurahData(surahNumber);
    }
    
    function displayCurrentAyah(withSpans = false) {
      if (!currentSurahData || currentAyahIndex >= currentSurahData.ayahs.length) {
        if (isListening || isRecitingFull) {
          status.textContent = 'ğŸ‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø³ÙˆØ±Ø©!';
          stopAll();
        }
        return;
      }
      
      const ayah = currentSurahData.ayahs[currentAyahIndex];
      
      if (withSpans) {
        const words = ayah.text.split(' ');
        let htmlContent = '';
        words.forEach((word, index) => {
          htmlContent += `<span id="word-${index}">${word}</span> `;
        });
        ayahText.innerHTML = htmlContent;
      } else {
        ayahText.textContent = ayah.text;
      }
      
      ayahInfo.textContent = `${currentSurahData.name} - Ø¢ÙŠØ© ${ayah.number}`;
      
      const progress = ((currentAyahIndex + 1) / currentSurahData.ayahs.length * 100).toFixed(1);
      progressBar.style.width = progress + '%';
      progressBar.textContent = progress + '%';
      
      ayahContainer.scrollTop = 0;
    }
    
    function displayBasmala(withSpans = false) {
      if (withSpans) {
        const words = BASMALA_TEXT.split(' ');
        let htmlContent = '';
        words.forEach((word, index) => {
          htmlContent += `<span id="basmala-word-${index}">${word}</span> `;
        });
        basmalaDiv.innerHTML = htmlContent;
      } else {
        basmalaDiv.textContent = BASMALA_TEXT;
      }
      basmalaDiv.style.display = 'block';
    }
    
    function scrollToWord(element) {
      if (!element) return;
      
      const container = ayahContainer;
      const elementRect = element.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();
      
      const relativeTop = elementRect.top - containerRect.top + container.scrollTop;
      const containerHeight = container.clientHeight;
      
      const targetScroll = relativeTop - (containerHeight * 0.25);
      
      container.scrollTop = Math.max(0, targetScroll);
    }
    
    function startWordHighlighting(isBasmalaMode = false, isBlueHighlight = false) {
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
      }
      
      const text = isBasmalaMode ? BASMALA_TEXT : currentSurahData.ayahs[currentAyahIndex].text;
      const words = text.split(' ');
      const prefix = isBasmalaMode ? 'basmala-word-' : 'word-';
      const highlightClass = isBlueHighlight ? 'highlight-blue' : 'highlight';
      
      let lastHighlightedIndex = -1;
      
      function updateHighlight() {
        if (!audioPlayer.paused && !audioPlayer.ended && (isRecitingFull || isPlayingInListenMode || isPlayingBasmala)) {
          const currentTime = audioPlayer.currentTime;
          const duration = audioPlayer.duration;
          
          if (duration > 0) {
            const progress = (currentTime / duration);
            const currentIndex = Math.floor(progress * words.length);
            
            if (currentIndex !== lastHighlightedIndex && currentIndex < words.length) {
              if (lastHighlightedIndex >= 0) {
                const prevWord = document.getElementById(`${prefix}${lastHighlightedIndex}`);
                if (prevWord) prevWord.classList.remove(highlightClass);
              }
              
              const currentWord = document.getElementById(`${prefix}${currentIndex}`);
              if (currentWord) {
                currentWord.classList.add(highlightClass);
                if (!isBasmalaMode) {
                  scrollToWord(currentWord);
                }
              }
              
              lastHighlightedIndex = currentIndex;
            }
          }
          
          animationFrameId = requestAnimationFrame(updateHighlight);
        } else {
          if (lastHighlightedIndex >= 0) {
            const lastWord = document.getElementById(`${prefix}${lastHighlightedIndex}`);
            if (lastWord) lastWord.classList.remove(highlightClass);
          }
        }
      }
      
      animationFrameId = requestAnimationFrame(updateHighlight);
    }
    
    function startListeningMode() {
      if (!currentSurahData) {
        alert('Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      
      currentAyahIndex = 0;
      lastDetectedAyahIndex = -1;
      nextAyahToPlay = 0;
      
      basmalaDiv.style.display = 'none';
      ayahText.textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©...';
      ayahInfo.textContent = currentSurahData.name;
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';
      
      if (!setupSpeechRecognition()) return;
      
      isListening = true;
      listenBtn.disabled = true;
      reciteBtn.disabled = true;
      stopBtn.disabled = false;
      delaySlider.disabled = true;
      startAyahInput.disabled = true;
      
      status.textContent = 'ğŸ¤ Ø§Ø³ØªÙ…Ø¹... Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©';
      status.classList.add('listening');
      
      try {
        recognition.start();
      } catch(e) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª:', e);
      }
    }
    
    function setupSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª');
        return false;
      }
      
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ar-SA';
      recognition.continuous = true;
      recognition.interimResults = true;
      
      recognition.onresult = function(event) {
        if (!isListening) return;
        
        let transcript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
          transcript += event.results[i][0].transcript;
        }
        
        if (transcript) {
          if (isPlayingInListenMode) {
            stopAudioAndReturnToListening();
          }
          
          findMatchingAyah(transcript);
          
          clearTimeout(silenceTimeout);
          clearInterval(silenceTimer);
          timerDisplay.style.display = 'none';
          
          silenceTimeout = setTimeout(() => {
            if (isListening && !isPlayingInListenMode) {
              resetSilenceTimer();
            }
          }, 2000);
        }
      };
      
      recognition.onerror = function(event) {
        if (event.error !== 'no-speech') {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª:', event.error);
        }
      };
      
      recognition.onend = function() {
        if (isListening && !isPlayingInListenMode) {
          try {
            recognition.start();
          } catch(e) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ¹Ø±Ù:', e);
          }
        }
      };
      
      return true;
    }
    
    function stopAudioAndReturnToListening() {
      try {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
      } catch(e) {}
      
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
      
      document.querySelectorAll('.ayah-text span').forEach(span => {
        span.classList.remove('highlight-blue');
      });
      
      isPlayingInListenMode = false;
      
      ayahText.textContent = 'Ø£ÙƒÙ…Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©...';
      ayahInfo.textContent = currentSurahData.name;
      
      status.textContent = 'ğŸ¤ Ø§Ø³ØªÙ…Ø¹... Ø£ÙƒÙ…Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©';
      status.classList.add('listening');
      status.classList.remove('reciting');
    }
    
    function findMatchingAyah(transcript) {
      if (!currentSurahData) return;
      
      const cleanTranscript = transcript.replace(/[^\u0600-\u06FF\s]/g, '').trim();
      if (cleanTranscript.length < 10) return;
      
      let bestMatch = { index: -1, score: 0 };
      
      for (let i = 0; i < currentSurahData.ayahs.length; i++) {
        const ayah = currentSurahData.ayahs[i];
        const cleanAyahText = ayah.text.replace(/[^\u0600-\u06FF\s]/g, '').trim();
        
        const words = cleanTranscript.split(/\s+/);
        let matchCount = 0;
        
        for (let word of words) {
          if (word.length > 2 && cleanAyahText.includes(word)) {
            matchCount++;
          }
        }
        
        const score = words.length > 0 ? (matchCount / words.length) : 0;
        
        if (score > bestMatch.score && score > 0.5) {
          bestMatch = { index: i, score: score };
        }
      }
      
      if (bestMatch.index !== -1 && bestMatch.index !== lastDetectedAyahIndex) {
        lastDetectedAyahIndex = bestMatch.index;
        nextAyahToPlay = bestMatch.index + 1;
        
        currentAyahIndex = bestMatch.index;
        displayCurrentAyah(false);
        
        const progress = ((bestMatch.index + 1) / currentSurahData.ayahs.length * 100).toFixed(1);
        progressBar.style.width = progress + '%';
        progressBar.textContent = progress + '%';
        
        status.textContent = 'âœ… Ø¢ÙŠØ© ' + currentSurahData.ayahs[bestMatch.index].number;
      }
    }
    
    function resetSilenceTimer() {
      if (isPlayingInListenMode || !isListening) return;
      
      clearInterval(silenceTimer);
      silenceCount = delaySeconds;
      timerCount.textContent = silenceCount;
      timerDisplay.style.display = 'block';
      
      silenceTimer = setInterval(function() {
        if (!isListening) {
          clearInterval(silenceTimer);
          return;
        }
        
        silenceCount--;
        timerCount.textContent = silenceCount;
        
        if (silenceCount <= 0) {
          clearInterval(silenceTimer);
          timerDisplay.style.display = 'none';
          playCurrentAyahInListenMode();
        }
      }, 1000);
    }
    
    function playCurrentAyahInListenMode() {
      if (!currentSurahData || !isListening) {
        return;
      }
      
      if (nextAyahToPlay >= currentSurahData.ayahs.length) {
        status.textContent = 'ğŸ‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø³ÙˆØ±Ø©!';
        stopAll();
        return;
      }
      
      currentAyahIndex = nextAyahToPlay;
      
      isPlayingInListenMode = true;
      displayCurrentAyah(true);
      
      const ayah = currentSurahData.ayahs[currentAyahIndex];
      
      status.textContent = 'ğŸ“» ØªØ´ØºÙŠÙ„ Ø¢ÙŠØ© ' + ayah.number;
      status.classList.remove('listening');
      status.classList.add('reciting');
      
      audioPlayer.src = ayah.audio;
      
      audioPlayer.oncanplay = function() {
        if (isListening && isPlayingInListenMode) {
          audioPlayer.play();
          startWordHighlighting(false, true);
        }
      };
      
      audioPlayer.onended = function() {
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
        }
        isPlayingInListenMode = false;
        
        if (!isListening) return;
        
        nextAyahToPlay = currentAyahIndex + 1;
        
        ayahText.textContent = 'Ø£ÙƒÙ…Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©...';
        ayahInfo.textContent = currentSurahData.name;
        status.textContent = 'ğŸ¤ Ø§Ø³ØªÙ…Ø¹...';
        status.classList.add('listening');
        status.classList.remove('reciting');
      };
      
      audioPlayer.onerror = function() {
        isPlayingInListenMode = false;
        if (!isListening) return;
        
        status.textContent = 'Ø®Ø·Ø£';
        ayahText.textContent = 'Ø£ÙƒÙ…Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©...';
      };
    }
    
    function startRecitationMode() {
      if (!currentSurahData) {
        alert('Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      
      const startFrom = parseInt(startAyahInput.value);
      if (startFrom && startFrom >= 1 && startFrom <= currentSurahData.ayahs.length) {
        currentAyahIndex = startFrom - 1;
      } else {
        currentAyahIndex = 0;
      }
      
      needBasmala = (currentAyahIndex === 0 && currentSurahData.number != 9 && currentSurahData.number != 1);
      
      isRecitingFull = true;
      listenBtn.disabled = true;
      reciteBtn.disabled = true;
      stopBtn.disabled = false;
      delaySlider.disabled = true;
      startAyahInput.disabled = true;
      
      status.textContent = 'ğŸ“– ØªÙ„Ø§ÙˆØ©...';
      status.classList.add('reciting');
      
      if (needBasmala) {
        playBasmala();
      } else {
        playNextAyahWithHighlight();
      }
    }
    
    function playBasmala() {
      isPlayingBasmala = true;
      displayBasmala(true);
      ayahText.innerHTML = '';
      ayahInfo.textContent = 'Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…';
      
      const basmalaAudio = `https://cdn.islamic.network/quran/audio/128/${selectedReciter}/1.mp3`;
      audioPlayer.src = basmalaAudio;
      
      audioPlayer.oncanplay = function() {
        if (isRecitingFull) {
          audioPlayer.play();
          startWordHighlighting(true, false);
        }
      };
      
      audioPlayer.onended = function() {
        isPlayingBasmala = false;
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
        }
        basmalaDiv.style.display = 'none';
        
        if (!isRecitingFull) return;
        
        setTimeout(() => {
          if (isRecitingFull) {
            playNextAyahWithHighlight();
          }
        }, 1000);
      };
      
      audioPlayer.onerror = function() {
        isPlayingBasmala = false;
        basmalaDiv.style.display = 'none';
        if (isRecitingFull) {
          playNextAyahWithHighlight();
        }
      };
    }
    
    function playNextAyahWithHighlight() {
      if (!currentSurahData || currentAyahIndex >= currentSurahData.ayahs.length || !isRecitingFull) {
        if (isRecitingFull) {
          status.textContent = 'ğŸ‰ Ø¥ÙƒÙ…Ø§Ù„!';
          stopAll();
        }
        return;
      }
      
      displayCurrentAyah(true);
      
      const ayah = currentSurahData.ayahs[currentAyahIndex];
      audioPlayer.src = ayah.audio;
      
      audioPlayer.oncanplay = function() {
        if (isRecitingFull) {
          audioPlayer.play();
          startWordHighlighting(false, false);
        }
      };
      
      audioPlayer.onended = function() {
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
        }
        
        if (!isRecitingFull) return;
        
        currentAyahIndex++;
        
        setTimeout(() => {
          if (isRecitingFull) {
            playNextAyahWithHighlight();
          }
        }, 1200);
      };
      
      audioPlayer.onerror = function() {
        if (isRecitingFull) {
          status.textContent = 'Ø®Ø·Ø£';
          stopAll();
        }
      };
    }
    
    function stopAll() {
      isListening = false;
      isRecitingFull = false;
      isPlayingBasmala = false;
      isPlayingInListenMode = false;
      needBasmala = false;
      lastDetectedAyahIndex = -1;
      nextAyahToPlay = 0;
      
      if (recognition) {
        try {
          recognition.stop();
        } catch(e) {}
      }
      
      try {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        audioPlayer.src = '';
      } catch(e) {}
      
      clearInterval(silenceTimer);
      clearTimeout(silenceTimeout);
      
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
      
      document.querySelectorAll('.ayah-text span, .basmala span').forEach(span => {
        span.classList.remove('highlight', 'highlight-blue');
      });
      
      basmalaDiv.style.display = 'none';
      
      status.textContent = 'ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù';
      status.classList.remove('listening', 'reciting');
      timerDisplay.style.display = 'none';
      
      listenBtn.disabled = false;
      reciteBtn.disabled = false;
      stopBtn.disabled = true;
      delaySlider.disabled = false;
      startAyahInput.disabled = false;
    }
    
    loadSurahs();
  </script>
</body>
</html>
